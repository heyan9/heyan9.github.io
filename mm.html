<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瑟瑟分享</title>
    <style>
        :root { --blue: #0066FF; --bg: #ffffff; --border: rgba(0,0,0,0.08); }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: #1a1a1a; }
        
        /* 导航栏 - 知乎蓝毛玻璃 */
        header { 
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 20px; font-weight: 700; color: var(--blue); text-decoration: none; }
        .nav-links a { text-decoration: none; color: #666; font-size: 14px; margin-left: 18px; font-weight: 500; transition: 0.2s; }
        .nav-links a:hover { color: var(--blue); }

        /* 瀑布流 */
        .container { max-width: 1300px; margin: 20px auto; padding: 0 15px; }
        .gallery { column-count: 4; column-gap: 15px; }
        @media (max-width: 1100px) { .gallery { column-count: 3; } }
        @media (max-width: 750px) { .gallery { column-count: 2; } }

        .img-card { 
            break-inside: avoid; margin-bottom: 15px; border-radius: 12px; 
            border: 1px solid var(--border); overflow: hidden; background: #f9f9f9;
            transition: transform 0.3s; cursor: zoom-in;
        }
        .img-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        .img-card img { width: 100%; display: block; height: auto; }

        /* 音乐播放器 - 左下角直连版 */
        #music-ctrl {
            position: fixed; bottom: 30px; left: 30px; z-index: 200;
            background: var(--blue); color: white;
            padding: 10px 22px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,102,255,0.3); display: flex; align-items: center; gap: 8px;
            transition: all 0.3s;
        }
        .is-playing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* 模态框预览 */
        #modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.98); backdrop-filter: blur(15px);
            z-index: 1000; justify-content: center; align-items: center; 
        }
        #modal img { max-width: 90%; max-height: 85%; border-radius: 8px; box-shadow: 0 10px 50px rgba(0,0,0,0.1); transition: opacity 0.2s; }
        
        /* 切换控制 */
        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.03); border: none; width: 60px; height: 60px;
            border-radius: 50%; font-size: 40px; color: #333; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
            user-select: none;
        }
        .nav-btn:hover { background: var(--blue); color: white; }
        #prev-btn { left: 30px; }
        #next-btn { right: 30px; }
        
        .close-btn { position: absolute; top: 25px; left: 25px; font-size: 30px; color: #999; cursor: pointer; padding: 10px; }
        .download-btn { position: absolute; top: 25px; right: 25px; background: var(--blue); color: white; padding: 10px 25px; border-radius: 25px; text-decoration: none; font-size: 14px; font-weight: 500; }

        .loader { text-align: center; padding: 100px; color: #bbb; }
    </style>
</head>
<body>

<header>
    <a href="#" class="brand">瑟瑟分享</a>
    <div class="nav-links">
        <a href="https://pornhub.com" target="_blank">Pornhub</a>
        <a href="https://e621.net" target="_blank">e621</a>
    </div>
</header>

<div class="container">
    <div id="gallery" class="gallery"></div>
    <div id="loader" class="loader">正在调取资源...</div>
</div>

<!-- 音乐播放 -->
<div id="music-ctrl" onclick="toggleMusic()">
    <span id="music-text">点击播放 BGM</span>
    <audio id="audio" loop preload="auto">
        <!-- 直接读取仓库根目录下的 3.mp3 -->
        <source src="./3.mp3" type="audio/mpeg">
    </audio>
</div>

<!-- 放大预览 -->
<div id="modal">
    <span class="close-btn" onclick="closeModal()">✕</span>
    <a id="dl-link" class="download-btn" download target="_blank">保存原图</a>
    
    <button class="nav-btn" id="prev-btn" onclick="changeImg(-1, event)">‹</button>
    <img id="modal-img" src="" alt="">
    <button class="nav-btn" id="next-btn" onclick="changeImg(1, event)">›</button>
</div>

<script>
    const CONFIG = {
        user: 'heyan9',
        repo: 'heyan9.github.io',
        folder: 'img2',
        branch: 'main' 
    };

    let allImages = [];
    let currentIndex = 0;
    const audio = document.getElementById('audio');
    const musicCtrl = document.getElementById('music-ctrl');
    const musicText = document.getElementById('music-text');

    // 1. 获取图片列表
    async function init() {
        try {
            const api = `https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/${CONFIG.folder}?ref=${CONFIG.branch}`;
            const res = await fetch(api);
            if (!res.ok) throw new Error("无法读取列表，请确认仓库为公开状态且文件夹名正确");
            
            const data = await res.json();
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            data.forEach(file => {
                if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    // 图片依然使用代理（因为 GitHub 原图在国内屏蔽非常严重，不代理极大概率打不开）
                    const rawUrl = `https://raw.githubusercontent.com/${CONFIG.user}/${CONFIG.repo}/${CONFIG.branch}/${CONFIG.folder}/${file.name}`;
                    const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(rawUrl)}`;
                    
                    allImages.push(proxyUrl);
                    
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `<img src="${proxyUrl}" loading="lazy">`;
                    const idx = allImages.length - 1;
                    card.onclick = () => openModal(idx);
                    gallery.appendChild(card);
                }
            });
            document.getElementById('loader').style.display = 'none';
        } catch (e) {
            document.getElementById('loader').innerHTML = `<span style="color:red">加载出错: ${e.message}</span>`;
        }
    }

    // 2. 模态框逻辑
    function openModal(index) {
        currentIndex = index;
        updateModal();
        document.getElementById('modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function updateModal() {
        const modalImg = document.getElementById('modal-img');
        modalImg.style.opacity = '0.5';
        const url = allImages[currentIndex];
        modalImg.src = url;
        document.getElementById('dl-link').href = url;
        modalImg.onload = () => { modalImg.style.opacity = '1'; };
    }

    function changeImg(step, event) {
        event.stopPropagation(); // 阻止触发背景点击关闭
        currentIndex = (currentIndex + step + allImages.length) % allImages.length;
        updateModal();
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // 3. 音乐播放控制 (直连版)
    function toggleMusic() {
        if (audio.paused) {
            audio.play().then(() => {
                musicCtrl.classList.add('is-playing');
                musicText.innerText = 'BGM 正在播放';
            }).catch(err => {
                alert("加载中，请稍后再试或点击页面任意处激活");
            });
        } else {
            audio.pause();
            musicCtrl.classList.remove('is-playing');
            musicText.innerText = 'BGM 已暂停';
        }
    }

    // 4. 辅助功能
    document.onkeydown = (e) => {
        if (document.getElementById('modal').style.display === 'flex') {
            if (e.key === "ArrowLeft") changeImg(-1, e);
            if (e.key === "ArrowRight") changeImg(1, e);
            if (e.key === "Escape") closeModal();
        }
    };

    document.getElementById('modal').onclick = (e) => {
        if (e.target.id === 'modal') closeModal();
    };

    init();
</script>
</body>
</html>
