<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>从夯到拉排行</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --hang: #FF3B30; --top: #FF9500; --rsr: #FFCC00; --npc: #F2F2F7; --la: #8E8E93;
      --judy-blue: #007AFF;
      --bg: #f0f2f5; --card-bg: #ffffff; --text: #1c1c1e; --border: #f0f0f0; --input-bg: #ffffff;
    }
    
    body.dark {
      --bg: #121212; --card-bg: #1c1c1e; --text: #f2f2f7; --border: #2c2c2e; --input-bg: #2c2c2e;
    }

    body { background: var(--bg); color: var(--text); font-family: -apple-system, "PingFang SC", sans-serif; touch-action: pan-y; transition: background 0.3s; }
    .glass { background: var(--card-bg); border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
    
    #mainTitle {
      background: transparent; border: none; outline: none;
      width: 100%; font-weight: 900; color: var(--text);
      padding: 0;
    }
    #mainTitle::placeholder { color: #888; }

    .t-row { display: flex; border-bottom: 1px solid var(--border); min-height: 110px; }
    .t-label {
      width: 90px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 16px; color: #1c1c1e; border-right: 1px solid var(--border);
      padding: 10px; text-align: center;
    }
    .t-content { flex: 1; display: flex; flex-wrap: wrap; gap: 12px; padding: 15px; align-content: center; min-height: 110px; }

    .tag-item {
      width: 80px; background: var(--card-bg); border-radius: 12px; padding: 6px;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: grab; border: 1px solid var(--border);
    }
    .tag-item img { width: 68px; height: 68px; border-radius: 8px; object-fit: cover; pointer-events: none; background: #f8f8f8; }
    .tag-item span { font-size: 11px; font-weight: 800; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }

    .btn-zoo { background: var(--judy-blue); color: white; padding: 10px 20px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 14px; }
    .input-zoo { background: var(--input-bg); border: 2px solid var(--border); border-radius: 12px; padding: 12px; width: 100%; outline: none; font-size: 14px; color: var(--text); }
    
    .doc-container { width: 100%; height: 750px; border: none; border-radius: 12px; background: white; }
    
    @media (max-width: 640px) {
      .doc-container { height: 500px; } 
      .t-label { width: 70px; font-size: 14px; }
      #mainTitle { font-size: 1.5rem; }
    }
  </style>
</head>
<body class="p-3 sm:p-8">

  <div class="max-w-4xl mx-auto flex flex-col gap-6">
    
    <!-- 头部：标题与按钮对齐 -->
    <div class="flex items-center justify-between px-2 gap-4">
      <div class="flex-1">
        <input type="text" id="mainTitle" class="text-3xl tracking-tight" placeholder="输入标题..." oninput="saveLocal()">
        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Real-Time Sync • Chinese Secret Code</p>
      </div>
      
      <div class="flex items-center gap-4 shrink-0">
        <button onclick="toggleDarkMode()" class="text-gray-400 hover:text-blue-500 transition text-xl">
            <i id="darkIcon" class="fas fa-moon"></i>
        </button>
        <button onclick="clearData()" class="text-xs font-bold text-red-400 hover:underline">重置</button>
      </div>
    </div>

    <!-- 排行榜 -->
    <div class="glass">
        <div class="t-row"><div class="t-label" style="background:var(--hang)">夯</div><div id="row-hang" class="t-content"></div></div>
        <div class="t-row"><div class="t-label" style="background:var(--top)">顶级</div><div id="row-top" class="t-content"></div></div>
        <div class="t-row"><div class="t-label" style="background:var(--rsr)">人上人</div><div id="row-rsr" class="t-content"></div></div>
        <div class="t-row"><div class="t-label" style="background:var(--npc)">NPC</div><div id="row-npc" class="t-content"></div></div>
        <div class="t-row"><div class="t-label" style="background:var(--la)">拉完了</div><div id="row-la" class="t-content"></div></div>
    </div>

    <!-- 注入池 -->
    <div class="glass p-6">
      <div class="flex gap-3 mb-4">
        <input id="batchIn" class="input-zoo" placeholder="输入名称(空格或逗号分隔)...">
        <button onclick="inject()" class="btn-zoo shrink-0">注入</button>
      </div>
      <div id="pool" class="min-h-[100px] flex flex-wrap gap-4 p-5 bg-black/5 rounded-2xl border-2 border-dashed border-gray-200"></div>
    </div>

    <!-- 数据备份 -->
    <div class="glass p-6">
      <h3 class="text-xs font-black mb-3 text-gray-500 uppercase tracking-widest">备份与还原 (中文暗码)</h3>
      <textarea id="ioBox" class="w-full bg-black/5 border-2 border-dashed border-gray-200 rounded-xl p-3 text-sm h-20 mb-3 outline-none text-blue-500 font-medium" placeholder="此处显示中文暗码..."></textarea>
      <div class="flex gap-2">
        <button onclick="exportData()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-black">生成暗码</button>
        <button onclick="copyData()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold text-xs hover:bg-gray-300">复制</button>
        <div class="flex-1"></div>
        <button onclick="importData()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-green-700">导入暗码</button>
      </div>
    </div>

    <!-- 文档内嵌 -->
    <div class="glass p-1">
      <iframe class="doc-container" src="https://docs.qq.com/doc/DZk50aGZqU3V1RVR0"></iframe>
    </div>

    <!-- 页脚 -->
    <div class="text-center pb-12">
      <a href="https://heyan9.github.io" target="_blank" class="inline-flex items-center gap-2 bg-white dark:bg-zinc-800 px-6 py-2 rounded-full shadow-sm border border-gray-100 dark:border-zinc-700 hover:shadow-md transition group">
        <span class="text-xs font-black text-gray-600 dark:text-gray-300 group-hover:text-blue-600">个人主页</span>
        <span class="text-gray-300 dark:text-zinc-600">|</span>
        <span class="text-xs font-bold text-gray-400 group-hover:text-gray-600">heyan9.github.io</span>
      </a>
    </div>
  </div>

  <script>
    const containers = ['row-hang', 'row-top', 'row-rsr', 'row-npc', 'row-la', 'pool'];

    // 核心：中文暗码转换逻辑 (数据 -> 压缩 -> 位移至中文字符区)
    function toChineseCode(obj) {
        const str = JSON.stringify(obj);
        let code = "";
        for (let i = 0; i < str.length; i++) {
            // 将字符编码位移到 CJK 常用汉字区 (0x4E00 附近)
            code += String.fromCharCode(str.charCodeAt(i) + 0x4E00);
        }
        return code;
    }

    function fromChineseCode(code) {
        let str = "";
        for (let i = 0; i < code.length; i++) {
            str += String.fromCharCode(code.charCodeAt(i) - 0x4E00);
        }
        return JSON.parse(str);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      document.getElementById('darkIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
      localStorage.setItem('heyan_dark_mode', isDark);
    }

    function getRealImage(name) {
      const query = encodeURIComponent(name);
      return `https://images.weserv.nl/?url=https://tse1-mm.cn.bing.net/th?q=${query}&w=160&h=160&c=7&rs=1&p=0&dpr=1&pid=ImgDetNav`;
    }

    function createTag(name) {
      const div = document.createElement('div');
      div.className = 'tag-item';
      div.setAttribute('data-name', name);
      div.innerHTML = `<img src="${getRealImage(name)}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=${name}'"><span>${name}</span>`;
      div.ondblclick = () => { div.remove(); saveLocal(); };
      return div;
    }

    function inject() {
      const input = document.getElementById('batchIn');
      const names = input.value.split(/[,，\s\n]/).map(n => n.trim()).filter(n => n);
      names.forEach(n => {
        if (!document.querySelector(`[data-name="${n}"]`)) {
          document.getElementById('pool').appendChild(createTag(n));
        }
      });
      input.value = '';
      saveLocal();
    }

    function saveLocal() {
      const data = {
        t: document.getElementById('mainTitle').value, // 简写 key 减小体积
        r: {}
      };
      containers.forEach(id => {
        data.r[id] = Array.from(document.getElementById(id).children).map(el => el.getAttribute('data-name'));
      });
      localStorage.setItem('heyan_ranking_v2', JSON.stringify(data));
    }

    function loadLocal() {
      if (localStorage.getItem('heyan_dark_mode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('darkIcon').className = 'fas fa-sun';
      }

      const raw = localStorage.getItem('heyan_ranking_v2');
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data.t) document.getElementById('mainTitle').value = data.t;
      if (data.r) {
        containers.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = '';
          if (data.r[id]) data.r[id].forEach(name => el.appendChild(createTag(name)));
        });
      }
    }

    function exportData() {
      const data = {
        t: document.getElementById('mainTitle').value,
        r: {}
      };
      containers.forEach(id => {
        data.r[id] = Array.from(document.getElementById(id).children).map(el => el.getAttribute('data-name'));
      });
      document.getElementById('ioBox').value = toChineseCode(data);
    }

    function importData() {
      const code = document.getElementById('ioBox').value.trim();
      if (!code) return;
      try {
        const data = fromChineseCode(code);
        if (data.t) document.getElementById('mainTitle').value = data.t;
        containers.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = '';
          if (data.r && data.r[id]) data.r[id].forEach(name => el.appendChild(createTag(name)));
        });
        saveLocal();
        alert('导入成功');
      } catch (e) { alert('暗码无效'); }
    }

    function copyData() {
      const box = document.getElementById('ioBox');
      box.select();
      document.execCommand('copy');
      alert('暗码已复制');
    }

    function clearData() {
      if(confirm("确定清空数据吗？")) {
        localStorage.removeItem('heyan_ranking_v2');
        location.reload();
      }
    }

    containers.forEach(id => {
      new Sortable(document.getElementById(id), {
        group: 'shared',
        animation: 200,
        ghostClass: 'opacity-10',
        onEnd: saveLocal
      });
    });

    window.onload = loadLocal;
  </script>
</body>
</html>
