<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <base target="_blank">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½•å²©æœç´¢ç«™ - å°Šäº«é‡åˆ¶ç‰ˆ</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <!-- å¼•å…¥ APlayer å’Œ MetingJS (ä¿®å¤éŸ³ä¹æ’­æ”¾çš„å…³é”®) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/meting/2.0.1/Meting.min.js"></script>

  <script src="https://code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
  
  <style>
    :root {
      --primary-blue: #0084ff;
      --bg-color: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(255,255,255,0.5);
      --border-color: #ebebeb;
      --text-main: #444;
      --text-sub: #8590a6;
      --input-bg: #fff;
      --item-hover: #fff;
      --shadow-color: rgba(0, 0, 0, 0.04);
      
      --rare-common: #7f8c8d;
      --rare-rare: #3498db;
      --rare-epic: #9b59b6;
      --rare-legend: #f1c40f;
    }

    /* æ·±è‰²æ¨¡å¼å˜é‡è¦†ç›– */
    body.dark-mode {
      --bg-color: #121212;
      --glass-bg: rgba(30, 30, 30, 0.9);
      --glass-border: rgba(255,255,255,0.1);
      --border-color: #333;
      --text-main: #e0e0e0;
      --text-sub: #aaa;
      --input-bg: #1e1e1e;
      --item-hover: #2c2c2c;
      --shadow-color: rgba(0, 0, 0, 0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: var(--bg-color);
      /* æ·±è‰²æ¨¡å¼ä¸‹è°ƒæ•´èƒŒæ™¯æ¸å˜ä½¿å…¶æŸ”å’Œ */
      background-image: radial-gradient(circle at 10% 20%, rgba(0, 132, 255, 0.05) 0%, transparent 20%), 
                        radial-gradient(circle at 90% 80%, rgba(0, 132, 255, 0.05) 0%, transparent 20%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      font-weight: 400;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- ç”¨æˆ·æ  --- */
    .user-bar {
      position: absolute; top: 20px; right: 20px;
      display: flex; align-items: center; 
      height: 40px; padding: 0 4px 0 16px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      box-shadow: 0 2px 12px var(--shadow-color);
      z-index: 100;
      gap: 12px; font-size: 13px;
      transition: all 0.3s;
    }
    .fish-stats { display: flex; align-items: center; gap: 6px; color: var(--text-main); cursor: default; height: 100%; }
    .level-badge { background: rgba(0, 132, 255, 0.1); color: var(--primary-blue); padding: 1px 6px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .divider { width: 1px; height: 14px; background: var(--border-color); }
    #authContainer { display: flex; align-items: center; height: 100%; }
    .auth-btn { background: var(--primary-blue); color: white; border: none; padding: 0 16px; height: 28px; border-radius: 14px; cursor: pointer; font-size: 12px; margin-right: 4px; }
    .auth-btn:hover { background: #0077e6; }
    
    /* æ–°å¢åŠŸèƒ½æŒ‰é’®æ ·å¼ */
    .icon-btn { background: transparent; color: var(--text-sub); border: none; font-size: 14px; cursor: pointer; padding: 0 5px; transition: color 0.2s; }
    .icon-btn:hover { color: var(--primary-blue); }

    .user-name { color: var(--text-main); margin-right: 8px; }
    .logout-btn { color: var(--text-sub); cursor: pointer; margin-right: 10px; }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 600px) {
      .user-bar { position: relative; top: auto; right: auto; margin-bottom: 20px; width: auto; justify-content: center; flex-wrap: wrap; height: auto; padding: 10px; }
      .content-wrapper { margin-top: 10px; }
    }

    /* ç™»å½•æ¡† */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .modal-box { background: var(--bg-color); padding: 30px; border-radius: 12px; width: 300px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; border: 1px solid var(--border-color); }
    .modal-box h3 { color: var(--text-main); }
    .modal-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 6px; outline: none; background: var(--input-bg); color: var(--text-main); }
    .btn-login { background: var(--primary-blue); color: #fff; width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; }

    /* --- ä¸»å¸ƒå±€ --- */
    .content-wrapper { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; max-width: 1000px; padding-bottom: 50px; margin-top: 60px; transition: all 0.5s; }
    .logo-container { margin-bottom: 40px; text-align: center; width: 100%; }
    .logo { width: 80%; max-width: 300px; height: auto; display: block; margin: 0 auto; }
    .logo-text { font-size: 36px; font-weight: 800; color: var(--primary-blue); display: none; }

    .search-container { width: 100%; max-width: 650px; margin-bottom: 30px; position: relative; z-index: 10; }
    .search-box { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 50px; padding: 5px; box-shadow: 0 2px 8px var(--shadow-color); transition: all 0.3s; }
    .search-box:focus-within { border-color: var(--primary-blue); box-shadow: 0 4px 15px rgba(0, 132, 255, 0.15); }
    #searchInput { flex: 1; height: 44px; border: none; background: transparent; outline: none; font-size: 16px; padding: 0 20px; color: var(--text-main); }
    #searchButton { background-color: var(--primary-blue); color: white; border: none; height: 44px; padding: 0 32px; border-radius: 40px; cursor: pointer; font-size: 15px; font-weight: 500; }

    .quick-nav { display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; width: 100%; max-width: 850px; flex-wrap: wrap; }
    .nav-item { display: flex; align-items: center; text-decoration: none; color: var(--text-sub); font-size: 14px; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
    .nav-item:hover { background: var(--item-hover); color: var(--primary-blue); transform: translateY(-2px); box-shadow: 0 2px 8px var(--shadow-color); }
    .nav-item i { margin-right: 8px; color: #999; }
    .nav-item:hover i { color: var(--primary-blue); }

    /* å¼€å…³æ  */
    .toggle-section { width: 100%; text-align: center; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .toggle-btn { background: var(--item-hover); border: 1px solid var(--border-color); color: #999; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 12px var(--shadow-color); display: inline-flex; align-items: center; justify-content: center; position: relative; }
    .toggle-btn:hover { color: var(--primary-blue); border-color: var(--primary-blue); transform: translateY(-2px); }
    .toggle-btn.active { background: var(--primary-blue); border-color: var(--primary-blue); color: white; }
    .toggle-btn.running::after { content: ''; position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: #4caf50; border: 2px solid #fff; border-radius: 50%; }

    .hidden-wrapper { width: 100%; max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 0; }
    .hidden-wrapper.open { opacity: 1; margin-top: 30px; }

    /* --- å·¥å…·æ  --- */
    .grid-limit { max-width: 900px; } .grid-limit.open { max-height: 1000px; }
    .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; }
    .tool-item { background: var(--item-hover); color: var(--text-sub); text-decoration: none; text-align: center; padding: 15px 5px; font-size: 13px; border: 1px solid var(--border-color); border-radius: 6px; transition: background 0.3s; }
    .tool-item:hover { color: var(--primary-blue); border-color: var(--primary-blue); }

    /* --- è®°è´¦æœ¬ --- */
    .account-limit { max-width: 650px; width: 100%; } .account-limit.open { max-height: 800px; }
    .account-container { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); border-radius: 20px; padding: 25px; display: flex; flex-direction: column; gap: 15px; }
    .acc-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .acc-month-title { font-size: 18px; font-weight: bold; color: var(--text-main); }
    .acc-total { font-size: 14px; color: var(--text-sub); }
    .acc-total span { font-size: 20px; color: #ff5252; font-weight: bold; font-family: monospace; }
    .acc-input-group { display: flex; gap: 10px; }
    .acc-input { padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; outline: none; flex: 1; background: var(--input-bg); color: var(--text-main); }
    #accAmount { width: 100px; flex: none; }
    .btn-add-acc { background: var(--primary-blue); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; }
    .acc-list { max-height: 300px; overflow-y: auto; }
    .acc-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    .acc-item:last-child { border-bottom: none; }
    .acc-date { color: #ccc; font-size: 12px; margin-right: 10px; font-family: monospace; }
    .acc-cost { color: #ff5252; font-weight: bold; }

    /* --- éŸ³ä¹æ’­æ”¾å™¨ --- */
    .music-limit { max-width: 600px; width: 100%; } 
    .music-limit.open { max-height: 600px; }
    
    .aplayer {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(16px);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 10px 40px -10px rgba(0, 132, 255, 0.1) !important;
      margin: 0 !important;
      font-family: inherit !important;
      color: #444; /* Force dark text in APlayer for better contrast in light mode */
    }
    body.dark-mode .aplayer { color: #ddd; }
    body.dark-mode .aplayer .aplayer-list ol li:hover { background: rgba(255,255,255,0.1) !important; }
    body.dark-mode .aplayer .aplayer-list ol li.aplayer-list-light { background: rgba(255,255,255,0.1) !important; }
    body.dark-mode .aplayer .aplayer-info .aplayer-music .aplayer-title { color: #eee; }
    body.dark-mode .aplayer .aplayer-info .aplayer-music .aplayer-author { color: #aaa; }

    .aplayer .aplayer-body { background: transparent !important; }
    .aplayer .aplayer-list { background: var(--glass-border) !important; }

    /* --- ä»»åŠ¡æ¸…å• --- */
    .task-limit { max-width: 650px; width: 100%; } .task-limit.open { max-height: 800px; }
    .task-container { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; gap: 20px; }
    .task-input-group { display: flex; gap: 10px; align-items: center; }
    .task-input { flex: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 10px; outline: none; background: var(--input-bg); color: var(--text-main); }
    .task-input:focus { border-color: var(--primary-blue); }
    .star-select { display: flex; gap: 5px; cursor: pointer; user-select: none; }
    .star-select i { color: #ddd; font-size: 18px; padding: 2px; }
    .star-select i.selected { color: #f1c40f; }
    .btn-add-task { background: var(--primary-blue); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 16px; flex-shrink: 0; }
    .task-list { max-height: 350px; overflow-y: auto; padding-right: 5px; }
    .task-item { display: flex; align-items: center; justify-content: space-between; background: var(--glass-border); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; transition: all 0.3s; }
    .task-item:hover { transform: translateX(2px); border-color: var(--primary-blue); background: var(--item-hover); }
    .task-item.active-running { border-color: var(--primary-blue); background: rgba(0, 132, 255, 0.06); }
    .t-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .t-title { font-size: 14px; font-weight: 500; color: var(--text-main); }
    .t-stars { font-size: 12px; color: #f1c40f; }
    .t-timer { font-family: monospace; font-size: 14px; color: var(--text-sub); margin: 0 15px; min-width: 70px; text-align: right; }
    .t-actions { display: flex; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; }
    .btn-play { background: #e3f2fd; color: var(--primary-blue); }
    body.dark-mode .btn-play { background: #1a3a5a; color: #4da3ff; }
    .btn-pause { background: var(--primary-blue); color: #fff; }
    .btn-del { background: transparent; color: #ccc; }
    .btn-del:hover { color: #ff5252; background: rgba(255, 0, 0, 0.1); }

    /* --- æ¸¸æˆç³»ç»Ÿ --- */
    .game-limit { max-width: 700px; width: 100%; } .game-limit.open { max-height: 1200px; }
    .game-container { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
    
    .game-main { height: 320px; display: flex; position: relative; border-bottom: 1px solid var(--border-color); }
    .game-scene { flex: 2; position: relative; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 50%, #4FC3F7 50%, #0288D1 100%); border-right: 1px solid var(--glass-border); overflow: hidden; }
    .game-cat { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); font-size: 60px; z-index: 10; }
    .fishing-line { position: absolute; top: 120px; left: calc(50% + 25px); width: 2px; height: 0; background: #555; transform-origin: top center; transition: height 0.5s ease-out; }
    .fishing-line.casting { height: 120px; }
    .bobber { position: absolute; bottom: -10px; left: -4px; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
    .fishing-line.casting .bobber { display: block; animation: bobbing 1s infinite alternate; }
    @keyframes bobbing { from { transform: translateY(0); } to { transform: translateY(5px); } }
    .alert-icon { position: absolute; top: 60px; left: calc(50% + 40px); font-size: 30px; color: #ff5252; font-weight: bold; opacity: 0; }
    .alert-icon.show { opacity: 1; animation: bounce 0.5s infinite; }
    
    /* çŒ«æŠ“è€é¼ å°æ¸¸æˆå±‚ */
    .minigame-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; flex-direction: column; align-items: center; justify-content: center; }
    .minigame-layer.active { display: flex; }
    .mg-info { color: #fff; margin-bottom: 15px; text-align: center; }
    .mg-timer { font-size: 24px; font-weight: bold; color: #f1c40f; }
    .mg-score { font-size: 18px; margin-top: 5px; }
    .mg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 240px; height: 240px; }
    .mg-hole { background: #5d4037; border-radius: 50%; border: 4px solid #8d6e63; position: relative; overflow: hidden; cursor: pointer; box-shadow: inset 0 5px 10px rgba(0,0,0,0.5); }
    .mg-mouse { font-size: 40px; position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); transition: bottom 0.1s; pointer-events: none; }
    .mg-mouse.up { bottom: 10px; }
    .mg-hit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; display: none; }
    .mg-hit.show { display: block; animation: fadeOut 0.5s forwards; }
    @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, -60%); } }

    .game-sidebar { flex: 1; background: var(--glass-border); padding: 15px; display: flex; flex-direction: column; font-size: 13px; }
    .game-controls { display: flex; gap: 5px; margin-bottom: 10px; }
    .btn-game-ctrl { flex: 1; padding: 6px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; color: white; }
    .btn-start { background: #4caf50; }
    .btn-stop { background: #ff9800; display: none; }
    .btn-shop { background: var(--primary-blue); }
    .log-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; font-family: monospace; border-top: 1px solid var(--border-color); padding-top: 5px; height: 200px; color: var(--text-main); }
    .log-item { font-size: 12px; }
    
    .quality-common { color: var(--rare-common); }
    .quality-rare { color: var(--rare-rare); font-weight: bold; }
    .quality-epic { color: var(--rare-epic); font-weight: bold; text-shadow: 0 0 2px rgba(155, 89, 182, 0.2); }
    .quality-legend { color: var(--rare-legend); font-weight: 800; text-shadow: 0 0 3px rgba(241, 196, 15, 0.4); animation: glow 2s infinite; }
    @keyframes glow { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* å•†åŸé¢æ¿ */
    .shop-panel { display: none; background: var(--bg-color); padding: 15px; border-top: 1px solid var(--border-color); }
    .shop-panel.active { display: block; }
    .shop-header { font-weight: bold; margin-bottom: 10px; color: var(--primary-blue); display: flex; justify-content: space-between; }
    .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .shop-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; background: var(--item-hover); }
    .shop-item:hover { border-color: var(--primary-blue); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .s-icon { font-size: 24px; margin-bottom: 5px; display: block; }
    .s-name { font-size: 12px; font-weight: bold; color: var(--text-main); display: block; }
    .s-desc { font-size: 11px; color: var(--text-sub); margin: 4px 0; display: block; }
    .s-price { font-size: 12px; color: #f39c12; font-weight: bold; }
    .buff-timer { background: #ffeaa7; color: #d35400; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: none; }

    .hot-limit { max-width: 600px; } .hot-limit.open { max-height: 500px; }
    .hot-box { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; height: 400px; display: flex; flex-direction: column; }
    iframe { width: 100%; height: 100%; border: none; }

    .footer { font-size: 12px; color: #ccc; margin-top: auto; padding-top: 20px; text-align: center; }

    /* --- ä¸“æ³¨æ¨¡å¼ --- */
    body.focus-mode .user-bar { display: none; }
    body.focus-mode .logo-container { display: none; }
    body.focus-mode .toggle-section { display: none; }
    body.focus-mode .footer { display: none; }
    body.focus-mode .hidden-wrapper { display: none !important; }
    
    /* éšè—Quick Navä¸­çš„å…¶ä»–å…ƒç´ ï¼Œåªä¿ç•™æ—¶é—´ */
    body.focus-mode .quick-nav a:not(:first-child),
    body.focus-mode .quick-nav div:last-child { display: none; }
    
    /* ä¸“æ³¨æ¨¡å¼ä¸‹çš„å¸ƒå±€è°ƒæ•´ */
    body.focus-mode .content-wrapper {
      justify-content: center;
      height: 100vh;
      margin-top: 0;
    }
    
    body.focus-mode .search-container {
      transform: scale(1.1);
      margin-bottom: 50px;
    }
    
    body.focus-mode .quick-nav {
      margin: 0;
      position: absolute;
      top: 55%;
    }
    
    body.focus-mode .nav-item {
      font-size: 24px;
      color: var(--text-main);
      background: transparent;
      pointer-events: none; /* ä¸“æ³¨æ—¶è®©æ—¶é—´ä»…ä½œä¸ºå±•ç¤ºï¼Œé˜²æ­¢è¯¯è§¦è·³è½¬ */
    }
    
    body.focus-mode #exitFocusBtn {
      display: block;
    }
    
    #exitFocusBtn {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.1);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      z-index: 999;
    }
    #exitFocusBtn:hover { background: var(--primary-blue); color: white; }

  </style>
</head>
<body>

  <!-- é€€å‡ºä¸“æ³¨æ¨¡å¼æŒ‰é’® -->
  <button id="exitFocusBtn" onclick="toggleFocusMode()">
    <i class="fas fa-sign-out-alt"></i> é€€å‡ºä¸“æ³¨æ¨¡å¼
  </button>

  <!-- ç”¨æˆ·çŠ¶æ€æ  -->
  <div class="user-bar">
    <div class="fish-stats" title="é’“é±¼ç­‰çº§ä¸é‡‘å¸">
      <span id="levelBadge" class="level-badge">Lv.1</span>
      <span id="levelTitle">å°è™¾ç±³</span>
      <div class="divider"></div>
      <i class="fas fa-coins" style="color:#f39c12; font-size:12px;"></i>
      <span id="userGold" style="font-family: monospace; font-weight:bold;">0</span>
    </div>
    <div class="divider"></div>
    <div id="authContainer">
      <button class="auth-btn" id="loginBtn" onclick="showAuthModal()">ç™»å½• / å­˜æ¡£</button>
      <div id="userInfo" style="display:none; align-items:center;">
        <span id="userNameDisplay" class="user-name"></span>
        <span class="logout-btn" onclick="handleLogout()">é€€å‡º</span>
      </div>
    </div>
    <div class="divider"></div>
    <!-- æ–°å¢åŠŸèƒ½æŒ‰é’® -->
    <button class="icon-btn" onclick="toggleDarkMode()" title="æ·±è‰²æ¨¡å¼"><i class="fas fa-moon"></i></button>
    <button class="icon-btn" onclick="toggleFocusMode()" title="ä¸“æ³¨æ¨¡å¼"><i class="fas fa-eye"></i></button>
  </div>

  <!-- ç™»å½•æ¡† -->
  <div class="modal-overlay" id="authModal">
    <div class="modal-box">
      <h3 style="margin-bottom:20px;">é€šè¡Œè¯</h3>
      <input type="text" id="username" class="modal-input" placeholder="ç”¨æˆ·å" autocomplete="off">
      <input type="password" id="password" class="modal-input" placeholder="å¯†ç ">
      <button class="btn-login" onclick="handleLogin()">ç™»å½• / æ³¨å†Œ</button>
      <button style="background:transparent; color:#8590a6; border:none; cursor:pointer;" onclick="closeAuthModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="logo-container">
      <img src="img/logo1.png" alt="Logo" class="logo" onerror="this.style.display='none';document.querySelector('.logo-text').style.display='inline-block'">
      <div class="logo-text">HE YAN</div>
    </div>

    <div class="search-container">
      <form action="https://www.baidu.com/s" method="get" class="search-box">
        <input type="text" id="searchInput" name="wd" placeholder="æœ‰é—®é¢˜ï¼Œå°±ä¼šæœ‰ç­”æ¡ˆ..." required autocomplete="off">
        <button type="submit" id="searchButton">æœç´¢</button>
      </form>
    </div>

    <div class="quick-nav">
      <a href="https://mp.weixin.qq.com/s?__biz=MzkyODM5OTgzMg==&mid=2247488236&idx=1&sn=b40d9af805b779de05b372b43a05c094" class="nav-item">
        <i class="far fa-clock"></i> <span id="dynamic-info" class="fade-anim">Loading...</span>
      </a>
      <a href="https://heyan9.github.io/è®°å½•.html" class="nav-item"><i class="fas fa-briefcase"></i> è®°å½•</a>
      <a href="https://heyan9.github.io/photo" class="nav-item"><i class="fas fa-camera"></i> æ‘„å½±å±•ç¤º</a>
      <!-- è¯»ä¹¦ç¬”è®°å·²ç§»è‡³ä¸‹æ–¹å·¥å…·ç®± -->
      <div class="nav-item" onclick="rollDice(this)" title="ç‚¹å‡»æ‘‡éª°å­">
        <i class="fas fa-dice"></i> <span id="diceText">éšæœºéª°å­</span>
      </div>
    </div>

    <div class="toggle-section">
      <button class="toggle-btn" id="btnTools" onclick="toggleSection('tools')"><i class="fas fa-chevron-down"></i></button>
      <button class="toggle-btn" id="btnMusic" onclick="toggleSection('music')"><i class="fas fa-music"></i></button>
      <button class="toggle-btn" id="btnTasks" onclick="toggleSection('tasks')"><i class="fas fa-tasks"></i></button>
      <button class="toggle-btn" id="btnAccount" onclick="toggleSection('account')"><i class="fas fa-wallet"></i></button>
      <button class="toggle-btn" id="btnGame" onclick="toggleSection('game')"><i class="fas fa-fish"></i></button>
      <button class="toggle-btn" id="btnHot" onclick="toggleSection('hot')"><i class="fab fa-weibo"></i></button>
    </div>

    <!-- ç½‘å€å¯¼èˆª -->
    <div class="hidden-wrapper grid-limit" id="toolsWrapper">
      <div class="tools-grid">
        <!-- è¯»ä¹¦ç¬”è®°ç§»å…¥æ­¤å¤„ -->
        <a href="https://www.tboxn.com/1504.html" class="tool-item">è¯»ä¹¦ç¬”è®°</a>
       <a href="https://heyan9.pages.dev/shuiyin.html" class="tool-item">å»æ°´å°</a>
        <a href="https://heyan9.pages.dev/hang.html" class="tool-item">ä»å¤¯åˆ°æ‹‰</a>
        <a href="https://heyan9.pages.dev/heyanzuocai.html" class="tool-item">åšèœåŠ©æ‰‹</a>
        <a href="https://heyan9.pages.dev/shengtu.html" class="tool-item">aiç”Ÿå›¾åŠ©æ‰‹</a>
        <a href="https://www.yikm.net/" class="tool-item">åœ¨çº¿æ¸¸æˆ</a>
        <a href="https://aistudio.google.com/" class="tool-item">è°·æ­Œç¼–ç¨‹ai</a>
        <a href="https://www.doubao.com/chat/" class="tool-item">è±†åŒ… AI</a>
        <a href="https://www.52pojie.cn/" class="tool-item">å¾çˆ±ç ´è§£</a>
        <a href="https://www.toutiao.com/" class="tool-item">ä»Šæ—¥å¤´æ¡</a>
        <a href="https://www.google.com.hk/" class="tool-item">Google</a>
        <a href="https://www.88mv.org/?ref=88ys.cn" class="tool-item">88å½±è§†</a>
        <a href="http://m.dodoge.me/" class="tool-item">Mç«™</a>
        <a href="https://www.66yingshi.com/" class="tool-item">è§†é¢‘BT</a>
        <a href="https://waifu2x.udp.jp/" class="tool-item">Waifu2x</a>
        <a href="https://www.dxomark.com/" class="tool-item">DXOmark</a>
        <a href="https://clipdrop.co/uncrop" class="tool-item">AI æ‹“å›¾</a>
        <a href="https://github.com/" class="tool-item">Github</a>
        <a href="https://pc.woozooo.com/" class="tool-item">è“å¥äº‘</a>
        <a href="https://fanyi.youdao.com/index.html#/" class="tool-item">åœ¨çº¿ç¿»è¯‘</a>
        <a href="https://tv.cctv.com/live/index.shtml" class="tool-item">CCTVç›´æ’­</a>
        <a href="http://www.2t58.com/" class="tool-item">æ— æŸéŸ³ä¹</a>
        <a href="https://cn.uptodown.com/" class="tool-item">å®‰å“åº”ç”¨</a>
        <a href="https://mail.google.com/" class="tool-item">Gmail</a>
        <a href="https://heyan9.pages.dev/dongzuo.html" class="tool-item">éšæœºåŠ¨ä½œ</a>
        <a href="https://ttsmaker.cn/" class="tool-item">æ–‡æœ¬è½¬è¯­éŸ³</a>
         <a href="https://ygpy.net/" class="tool-item">å…è´¹æœºåœºèŠ‚ç‚¹æ•´åˆ</a>
         <a href="https://1.juanwangjc.top/#/dashboard" class="tool-item">å·ç‹æœºåœº</a>
        <a href="https://bento.me/freecloud" class="tool-item">å…è´¹æœºåœº</a>
        <a href="https://tianqi.moji.com/weather/china/hunan/miluo" class="tool-item">å¢¨è¿¹å¤©æ°”</a>
        <a href="https://wallpapercave.com/" class="tool-item">å£çº¸ä¸‹è½½</a>
        <a href="https://chat.chat826.com/#/home" class="tool-item">Chat8</a>
        <a href="https://weread.qq.com/web/shelf" class="tool-item">å¾®ä¿¡è¯»ä¹¦</a>
        <a href="https://www.ilovepdf.com/" class="tool-item">PDFè½¬æ¢</a>
        <a href="https://ucnrbg5e0s07.feishu.cn/minutes/home" class="tool-item">é£ä¹¦å¦™è®°</a>
        <a href="https://pdftoword.55.la/" class="tool-item">è½¬è½¬å¤§å¸ˆ</a>
        <a href="https://koodo.960960.xyz/zh" class="tool-item">Koodo</a>
        <a href="https://zh.z-library.se/" class="tool-item">Z-Library</a>
        <a href="https://onlinecamscanner.com/zh-Hans/" class="tool-item">åœ¨çº¿æ‰«æ</a>
        <a href="https://vocalremover.org/zh/" class="tool-item">åˆ†ç¦»äººå£°</a>
        <a href="https://heyan9.pages.dev/mm.html" class="tool-item">mm</a>
      </div>
    </div>

    <!-- è®°è´¦æœ¬ -->
    <div class="hidden-wrapper account-limit" id="accountWrapper">
      <div class="account-container">
        <div class="acc-header">
          <div class="acc-month-title" id="accMonthTitle">...</div>
          <div class="acc-total">æœ¬æœˆæ”¯å‡º: <span id="accTotalDisplay">0</span> å…ƒ</div>
        </div>
        <div class="acc-input-group">
          <input type="text" id="accDesc" class="acc-input" placeholder="æ¶ˆè´¹é¡¹ç›® (å¦‚: æ—©é¤)">
          <input type="number" id="accAmount" class="acc-input" placeholder="é‡‘é¢">
          <button class="btn-add-acc" onclick="addExpense()">è®°ä¸€ç¬”</button>
        </div>
        <div class="acc-list" id="accList">
          <div style="text-align:center;color:#ccc;margin-top:20px;">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ (APlayer + MetingJS ç»ˆæä¿®å¤ç‰ˆ) -->
    <div class="hidden-wrapper music-limit" id="musicWrapper">
      <!-- 
        server="netease" : ä½¿ç”¨ç½‘æ˜“äº‘æº
        type="playlist"  : æ’­æ”¾æ­Œå•
        id="3778678"     : ç½‘æ˜“äº‘çƒ­æ­Œæ¦œID
      -->
      <meting-js
        server="netease"
        type="playlist"
        id="3778678"
        fixed="false"
        autoplay="false"
        loop="all"
        order="list"
        preload="auto"
        list-folded="false"
        list-max-height="340px"
        lrc-type="0"
        theme="#0084ff">
      </meting-js>
    </div>

    <!-- ä»»åŠ¡æ¸…å• -->
    <div class="hidden-wrapper task-limit" id="tasksWrapper">
      <div class="task-container">
        <div class="task-input-group">
          <input type="text" id="newTaskInput" class="task-input" placeholder="è¾“å…¥æ–°ä»»åŠ¡...">
          <div class="star-select" id="newStarSelect">
            <i class="fas fa-star selected" onclick="setStar(1)"></i>
            <i class="fas fa-star selected" onclick="setStar(2)"></i>
            <i class="fas fa-star selected" onclick="setStar(3)"></i>
            <i class="fas fa-star" onclick="setStar(4)"></i>
            <i class="fas fa-star" onclick="setStar(5)"></i>
          </div>
          <button class="btn-add-task" onclick="addNewTask()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="task-list" id="taskListContainer">
          <div class="empty-tip" style="text-align:center;color:#999;margin-top:10px;">æš‚æ— ä»»åŠ¡</div>
        </div>
      </div>
    </div>

    <!-- è±ªåé’“é±¼æ¸¸æˆ + çŒ«æŠ“è€é¼  -->
    <div class="hidden-wrapper game-limit" id="gameWrapper">
      <div class="game-container">
        <div class="game-main">
          <div class="game-scene">
            <div class="alert-icon" id="gameAlert">!</div>
            <div class="game-cat" id="catSprite">ğŸ±</div>
            <div class="fishing-line" id="fishingLine"><div class="bobber"></div></div>
            <div id="buffTimer" class="buff-timer" style="position:absolute;top:10px;left:10px;">é‡‘åŠæ†ç”Ÿæ•ˆä¸­...</div>
            
            <!-- å°æ¸¸æˆç•Œé¢ (éšè—) -->
            <div id="miniGamePanel" class="minigame-layer">
               <div class="mg-info">
                 <div class="mg-timer">æ—¶é—´: <span id="mgTime">60</span>s</div>
                 <div class="mg-score">é‡‘å¸: <span id="mgScore">0</span></div>
               </div>
               <div class="mg-grid" id="mgGrid">
                 <!-- ç”Ÿæˆ9ä¸ªæ´ -->
                 <div class="mg-hole" onclick="whack(0)"><div class="mg-mouse" id="mouse-0">ğŸ­</div><div class="mg-hit" id="hit-0">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(1)"><div class="mg-mouse" id="mouse-1">ğŸ­</div><div class="mg-hit" id="hit-1">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(2)"><div class="mg-mouse" id="mouse-2">ğŸ­</div><div class="mg-hit" id="hit-2">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(3)"><div class="mg-mouse" id="mouse-3">ğŸ­</div><div class="mg-hit" id="hit-3">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(4)"><div class="mg-mouse" id="mouse-4">ğŸ­</div><div class="mg-hit" id="hit-4">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(5)"><div class="mg-mouse" id="mouse-5">ğŸ­</div><div class="mg-hit" id="hit-5">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(6)"><div class="mg-mouse" id="mouse-6">ğŸ­</div><div class="mg-hit" id="hit-6">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(7)"><div class="mg-mouse" id="mouse-7">ğŸ­</div><div class="mg-hit" id="hit-7">ğŸ’¥</div></div>
                 <div class="mg-hole" onclick="whack(8)"><div class="mg-mouse" id="mouse-8">ğŸ­</div><div class="mg-hit" id="hit-8">ğŸ’¥</div></div>
               </div>
            </div>

          </div>
          <div class="game-sidebar">
            <div class="game-controls">
              <button class="btn-game-ctrl btn-start" id="btnStartGame" onclick="userStartGame()">å¼€å§‹æŒ‚æœº</button>
              <button class="btn-game-ctrl btn-stop" id="btnStopGame" onclick="userStopGame()">æš‚åœ</button>
              <button class="btn-game-ctrl btn-shop" onclick="toggleShop()">æ¸”å…·åº—</button>
            </div>
            <div class="log-list" id="gameLog">
              <div class="log-item">æ¬¢è¿ï¼æŒ‚æœºå¯è·å¾—é‡‘å¸ä¸ç»éªŒã€‚</div>
              <div class="log-item">éš¾åº¦å·²æå‡ï¼Œä¼ è¯´é±¼æéš¾ä¸Šé’©ã€‚</div>
            </div>
          </div>
        </div>
        
        <!-- å•†åº—é¢æ¿ -->
        <div class="shop-panel" id="shopPanel">
          <div class="shop-header">
            <span><i class="fas fa-store"></i> æ¸”å…·å•†åŸ</span>
            <span style="font-size:12px;cursor:pointer;" onclick="toggleShop()">å…³é—­ x</span>
          </div>
          <div class="shop-grid">
            <div class="shop-item" onclick="buyItem('upgradeRod')">
              <i class="fas fa-magic s-icon" style="color:#3498db;"></i>
              <span class="s-name">å‡çº§é±¼ç«¿</span>
              <span class="s-desc">æå‡é«˜ç¨€æœ‰åº¦æ¦‚ç‡</span>
              <span class="s-price" id="priceRod">1000 G</span>
            </div>
            <div class="shop-item" onclick="buyItem('upgradePond')">
              <i class="fas fa-water s-icon" style="color:#2ecc71;"></i>
              <span class="s-name">æ‰©å»ºé±¼å¡˜</span>
              <span class="s-desc">åŠ å¿«ä¸Šé’©é€Ÿåº¦</span>
              <span class="s-price" id="pricePond">2000 G</span>
            </div>
            <div class="shop-item" onclick="buyItem('goldChest')">
              <i class="fas fa-box-open s-icon" style="color:#e74c3c;"></i>
              <span class="s-name">é£é™©å®ç®±</span>
              <span class="s-desc">æé«˜äºæœ¬ç‡ï¼Œåšæš´å‡»</span>
              <span class="s-price">5999 G</span>
            </div>
            <div class="shop-item" onclick="buyItem('gameConsole')">
              <i class="fas fa-gamepad s-icon" style="color:#8e44ad;"></i>
              <span class="s-name">çŒ«æ‰è€é¼ </span>
              <span class="s-desc">é™æ—¶60sèµ¢20000é‡‘</span>
              <span class="s-price">3999 G</span>
            </div>
            <div class="shop-item" onclick="buyItem('goldenRod')">
              <i class="fas fa-star s-icon" style="color:#e67e22;"></i>
              <span class="s-name">é‡‘åŠæ† (10åˆ†)</span>
              <span class="s-desc">å¿…å‡ºå®ç®±ç±»ç‰©å“</span>
              <span class="s-price">19999 G</span>
            </div>
            <div class="shop-item" onclick="buyItem('dogeCoin')">
              <i class="fas fa-dog s-icon" style="color:#95a5a6;"></i>
              <span class="s-name">ç‹—ç‹—å¸</span>
              <span class="s-desc">æå¸è‡³MetaMask</span>
              <span class="s-price">999999 G</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¾®åšçƒ­æœ -->
    <div class="hidden-wrapper hot-limit" id="hotWrapper">
      <div class="hot-box">
        <iframe src="https://s.weibo.com/top/summary?cate=realtimehot"></iframe>
      </div>
    </div>

  </div>

  <div class="footer">Created by He Yan | Â© 2025 12 | <span id="syncStatus">äº‘ç«¯æœªè¿æ¥</span></div>

<script>
  // LeanCloud Config
  const APP_ID = "vcJyhwqg1HpbKXiLUvLHzFIh-gzGzoHsz";
  const APP_KEY = "hknbmRcwH2bJDcqxRvLR67mk";
  const SERVER_URL = "https://vcjyhwqg.lc-cn-n1-shared.com";

  let isCloudEnabled = false;
  try {
    if (APP_ID) {
      AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
      isCloudEnabled = true;
      document.getElementById('syncStatus').innerText = "äº‘ç«¯å·²è¿æ¥";
      document.getElementById('syncStatus').style.color = "#4caf50";
    }
  } catch (e) { console.error("LC Init", e); }

  let currentUser = null;
  // Game Stats
  let userExp = 0;
  let userGold = 0;
  let rodLevel = 1;
  let pondLevel = 1;
  let goldenRodEndTime = 0; // Buff timestamp

  // Init
  if (isCloudEnabled) {
    currentUser = AV.User.current();
    if (currentUser) {
      updateUIForLogin(currentUser);
      syncUserData();
      loadTasksFromCloud();
      loadExpenses();
    }
  }
  
  // --- New Features Logic ---
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  function toggleFocusMode() {
    document.body.classList.toggle('focus-mode');
  }

  // Load theme preference
  if(localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  // --- Auth Logic ---
  function showAuthModal() { document.getElementById('authModal').style.display = 'flex'; }
  function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
  function handleLogout() { if(confirm("é€€å‡ºç™»å½•ï¼Ÿ")) { AV.User.logOut(); window.location.reload(); } }

  async function handleLogin() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if(!u || !p) return;
    try {
      currentUser = await AV.User.logIn(u, p);
      closeAuthModal(); updateUIForLogin(currentUser); 
      syncUserData(); loadTasksFromCloud(); loadExpenses();
    } catch (e) {
      if(e.code===211||e.code===210) {
        const user=new AV.User(); user.setUsername(u); user.setPassword(p);
        user.set('exp',0); user.set('gold',0); user.set('rodLevel',1); user.set('pondLevel',1);
        try{ currentUser=await user.signUp(); closeAuthModal(); updateUIForLogin(currentUser); }
        catch(re){ alert(re.message); }
      } else alert(e.message);
    }
  }

  function updateUIForLogin(user) {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('userNameDisplay').innerText = user.getUsername();
  }

  async function syncUserData() {
    if(!currentUser) return;
    await currentUser.fetch();
    userExp = currentUser.get('exp') || 0;
    userGold = currentUser.get('gold') || 0;
    rodLevel = currentUser.get('rodLevel') || 1;
    pondLevel = currentUser.get('pondLevel') || 1;
    updateStatusDisplay();
    updateShopPrices();
  }

  // --- Common UI ---
  function toggleSection(type) {
    const ids = { tools: 'toolsWrapper', music: 'musicWrapper', tasks: 'tasksWrapper', game: 'gameWrapper', hot: 'hotWrapper', account: 'accountWrapper' };
    const btns = { tools: 'btnTools', music: 'btnMusic', tasks: 'btnTasks', game: 'btnGame', hot: 'btnHot', account: 'btnAccount' };
    const targetEl = document.getElementById(ids[type]);
    const isOpen = targetEl.classList.contains('open');
    for(let k in ids) { document.getElementById(ids[k]).classList.remove('open'); document.getElementById(btns[k]).classList.remove('active'); }
    if(!isOpen) { targetEl.classList.add('open'); document.getElementById(btns[type]).classList.add('active'); }
  }

  function rollDice(el) {
    const val = Math.floor(Math.random() * 6) + 1;
    el.querySelector('span').innerText = `ç‚¹æ•°: ${val}`;
    const icon = el.querySelector('i');
    icon.className = `fas fa-dice-${['one','two','three','four','five','six'][val-1]}`;
    el.style.color = "var(--primary-blue)";
    setTimeout(() => { el.style.color = ""; }, 500);
  }
  
  const infoEl = document.getElementById('dynamic-info');
  setInterval(() => { const now=new Date(); infoEl.innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; }, 1000);

  // --- Task System ---
  const TodoItem = AV.Object.extend('TodoItem');
  let tasks = []; let activeTaskId = null; let taskTimerInterval = null; let taskStartTime = 0; let curStars=3;
  function setStar(n) { curStars=n; const s=document.getElementById('newStarSelect').children; for(let i=0;i<5;i++) s[i].className=i<n?'fas fa-star selected':'fas fa-star'; }
  async function loadTasksFromCloud() {
    if(!currentUser) return;
    const q=new AV.Query('TodoItem'); q.equalTo('user', currentUser); q.descending('stars');
    try { const r=await q.find(); tasks=r.map(i=>({id:i.id, title:i.get('title'), stars:i.get('stars'), totalSeconds:i.get('totalSeconds')||0, obj:i})); renderTasks(); } catch(e){}
  }
  async function addNewTask() {
    if(!currentUser) return alert("è¯·å…ˆç™»å½•");
    const t=document.getElementById('newTaskInput').value.trim(); if(!t)return;
    const obj=new TodoItem(); obj.set('title',t); obj.set('stars',curStars); obj.set('user',currentUser);
    await obj.save();
    tasks.unshift({id:obj.id, title:t, stars:curStars, totalSeconds:0, obj:obj}); renderTasks(); document.getElementById('newTaskInput').value='';
  }
  function renderTasks() {
    const c=document.getElementById('taskListContainer');
    if(!tasks.length) { c.innerHTML='<div class="empty-tip" style="text-align:center;color:#999">æš‚æ— ä»»åŠ¡</div>'; return; }
    c.innerHTML = tasks.map(t => {
      const run = t.id===activeTaskId;
      return `<div class="task-item ${run?'active-running':''}">
        <div class="t-info"><div class="t-title">${t.title}</div><div class="t-stars">${'â˜…'.repeat(t.stars)}</div></div>
        <div class="t-timer" id="timer-${t.id}">${formatTime(t.totalSeconds)}</div>
        <div class="t-actions">
          <button class="btn-icon ${run?'btn-pause':'btn-play'}" onclick="toggleTimer('${t.id}')"><i class="fas ${run?'fa-pause':'fa-play'}"></i></button>
          <button class="btn-icon btn-del" onclick="delTask('${t.id}')"><i class="fas fa-trash"></i></button>
        </div></div>`
    }).join('');
  }
  function toggleTimer(id) { if(activeTaskId===id) stopTimer(id); else { if(activeTaskId) stopTimer(activeTaskId); startTimer(id); } }
  function startTimer(id) { activeTaskId=id; taskStartTime=Date.now(); renderTasks(); taskTimerInterval=setInterval(()=>{ const el=document.getElementById('timer-'+id); if(el) el.innerText=formatTime(tasks.find(t=>t.id===id).totalSeconds + Math.floor((Date.now()-taskStartTime)/1000)); },1000); }
  function stopTimer(id) { clearInterval(taskTimerInterval); const t=tasks.find(x=>x.id===id); if(t){ t.totalSeconds+=Math.floor((Date.now()-taskStartTime)/1000); t.obj.set('totalSeconds',t.totalSeconds); t.obj.save(); } activeTaskId=null; renderTasks(); }
  async function delTask(id) { if(!confirm("åˆ é™¤?"))return; if(activeTaskId===id) stopTimer(id); const i=tasks.findIndex(t=>t.id===id); if(i>-1){ await tasks[i].obj.destroy(); tasks.splice(i,1); renderTasks(); } }
  function formatTime(s) { return new Date(s*1000).toISOString().substr(11,8); }

  // --- Accounting System ---
  const Expense = AV.Object.extend('Accounting');
  async function loadExpenses() {
    if (!currentUser) return;
    const date = new Date();
    const start = new Date(date.getFullYear(), date.getMonth(), 1);
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
    document.getElementById('accMonthTitle').innerText = `${date.getMonth()+1}æœˆè´¦å•`;
    
    const q = new AV.Query('Accounting');
    q.equalTo('user', currentUser);
    q.greaterThanOrEqualTo('createdAt', start);
    q.lessThanOrEqualTo('createdAt', end);
    q.descending('createdAt');
    
    try {
      const results = await q.find();
      let total = 0;
      const listHtml = results.map(e => {
        const amt = e.get('amount');
        total += amt;
        const d = e.createdAt;
        const dateStr = `${d.getDate()}æ—¥ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return `<div class="acc-item">
          <span><span class="acc-date">${dateStr}</span>${e.get('desc')}</span>
          <span class="acc-cost">-${amt}</span>
        </div>`;
      }).join('');
      document.getElementById('accList').innerHTML = listHtml || '<div style="text-align:center;color:#eee">æœ¬æœˆæ— æ”¯å‡º</div>';
      document.getElementById('accTotalDisplay').innerText = total;
    } catch(e) { console.error(e); }
  }

  async function addExpense() {
    if(!currentUser) return alert("è¯·ç™»å½•åè®°è´¦");
    const d = document.getElementById('accDesc').value.trim();
    const a = parseFloat(document.getElementById('accAmount').value);
    if(!d || !a) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");
    const exp = new Expense();
    exp.set('desc', d); exp.set('amount', a); exp.set('user', currentUser);
    try {
      await exp.save();
      document.getElementById('accDesc').value = '';
      document.getElementById('accAmount').value = '';
      loadExpenses();
    } catch(e) { alert("ä¿å­˜å¤±è´¥"); }
  }

  // --- Game System ---
  let isGameRunning = false;
  let gameTimer = null;
  const FISH_DB = [
    { name: "ç ´é´å­", type: "common", gold: 1, exp: 1, baseProb: 0.3 },
    { name: "å°è‰é±¼", type: "common", gold: 5, exp: 5, baseProb: 0.3 },
    { name: "é²«é±¼", type: "common", gold: 8, exp: 8, baseProb: 0.2 },
    { name: "è™¹é³Ÿ", type: "rare", gold: 25, exp: 30, baseProb: 0.1 },
    { name: "è“é³é‡‘æª", type: "rare", gold: 50, exp: 60, baseProb: 0.05 },
    { name: "ç»éªŒå®ç®±", type: "epic", gold: 0, exp: 500, baseProb: 0.02 },
    { name: "å¤§ç™½é²¨", type: "epic", gold: 200, exp: 200, baseProb: 0.02 },
    { name: "å¤ä»£æµ·æ€ª", type: "legend", gold: 1000, exp: 1000, baseProb: 0.005 },
    { name: "é¾™ç‹å®è—", type: "legend", gold: 5000, exp: 0, baseProb: 0.005 }
  ];

  function calculateLevel() {
    return Math.floor(Math.sqrt(userExp) / 10) + 1;
  }
  
  function getTitle(lv) {
    if(lv < 5) return "å°è™¾ç±³";
    if(lv < 10) return "è§ä¹ é’“æ‰‹";
    if(lv < 20) return "æ•é±¼è¾¾äºº";
    if(lv < 40) return "æµ·ç‹";
    if(lv < 60) return "ä¼ è¯´é’“ç¥";
    return "æ³¢å¡å†¬";
  }

  function updateStatusDisplay() {
    const lv = calculateLevel();
    document.getElementById('levelBadge').innerText = `Lv.${lv}`;
    document.getElementById('levelTitle').innerText = getTitle(lv);
    document.getElementById('userGold').innerText = userGold;
  }

  function userStartGame() {
    if(isGameRunning) return;
    isGameRunning = true;
    document.getElementById('btnStartGame').style.display='none';
    document.getElementById('btnStopGame').style.display='inline-block';
    document.getElementById('btnGame').classList.add('running');
    addGameLog("æŒ‚æœºå·²å¼€å§‹...", "common");
    loopGame();
  }

  function userStopGame() {
    isGameRunning = false;
    clearTimeout(gameTimer);
    document.getElementById('btnStartGame').style.display='inline-block';
    document.getElementById('btnStopGame').style.display='none';
    document.getElementById('btnGame').classList.remove('running');
    document.getElementById('fishingLine').classList.remove('casting');
    document.getElementById('gameAlert').classList.remove('show');
    addGameLog("æŒ‚æœºæš‚åœã€‚", "common");
  }

  function loopGame() {
    if(!isGameRunning) return;
    const waitTime = Math.max(2000, 6000 - (pondLevel * 200)) + Math.random() * 2000;
    gameTimer = setTimeout(() => {
      document.getElementById('fishingLine').classList.add('casting');
      gameTimer = setTimeout(async () => {
        document.getElementById('gameAlert').classList.add('show');
        await new Promise(r => setTimeout(r, 800));
        processCatch();
        document.getElementById('fishingLine').classList.remove('casting');
        document.getElementById('gameAlert').classList.remove('show');
        loopGame();
      }, 1500);
    }, waitTime);
  }

  function processCatch() {
    if(!isGameRunning) return;
    const hasBuff = Date.now() < goldenRodEndTime;
    if(hasBuff) document.getElementById('buffTimer').style.display = 'block';
    else document.getElementById('buffTimer').style.display = 'none';

    let caught = null;
    if (hasBuff) {
      const chests = FISH_DB.filter(f => f.name.includes('å®ç®±') || f.name.includes('å®è—'));
      caught = chests[Math.floor(Math.random() * chests.length)];
    } else {
      const roll = Math.random();
      let acc = 0;
      const luckMultiplier = 1 + (rodLevel * 0.1); 
      let pool = FISH_DB.map(f => ({ ...f, prob: f.baseProb * (f.type==='common'?1:luckMultiplier) }));
      const totalProb = pool.reduce((a,b)=>a+b.prob,0);
      const normalizedRoll = roll * totalProb;
      for(let f of pool) {
        acc += f.prob;
        if(normalizedRoll < acc) { caught = f; break; }
      }
      if(!caught) caught = FISH_DB[0];
    }
    userGold += caught.gold; userExp += caught.exp;
    updateStatusDisplay();
    addGameLog(`é’“åˆ°äº† [${caught.name}] +${caught.gold}G +${caught.exp}XP`, caught.type);
    if(currentUser) {
      currentUser.set('gold', userGold); currentUser.set('exp', userExp);
      currentUser.save().catch(e=>console.log('Autosave fail',e));
    }
  }

  function addGameLog(text, type) {
    const box = document.getElementById('gameLog');
    const div = document.createElement('div');
    div.className = `log-item quality-${type}`;
    div.innerHTML = `<span style="color:#ccc">[${new Date().toLocaleTimeString('zh-CN',{hour12:false,minute:'2-digit',second:'2-digit'})}]</span> ${text}`;
    box.appendChild(div); box.scrollTop = box.scrollHeight;
  }

  // --- Mini Game: Whack-a-Mole ---
  let mgTimer = null;
  let mgSpawnTimer = null;
  let mgScore = 0;
  let mgTimeLeft = 60;
  
  function startMiniGame() {
    if(userGameRunning()) userStopGame(); // Stop fishing if running
    document.getElementById('miniGamePanel').classList.add('active');
    mgScore = 0;
    mgTimeLeft = 60;
    document.getElementById('mgScore').innerText = mgScore;
    document.getElementById('mgTime').innerText = mgTimeLeft;
    
    // Countdown
    mgTimer = setInterval(() => {
      mgTimeLeft--;
      document.getElementById('mgTime').innerText = mgTimeLeft;
      if(mgTimeLeft <= 0) endMiniGame();
    }, 1000);
    
    // Spawner
    mgSpawnTimer = setInterval(spawnMouse, 700);
  }
  
  function spawnMouse() {
    const holes = document.getElementsByClassName('mg-mouse');
    for(let h of holes) h.classList.remove('up'); // clear old
    const idx = Math.floor(Math.random() * 9);
    const mouse = document.getElementById(`mouse-${idx}`);
    mouse.classList.add('up');
    setTimeout(() => { if(mouse.classList.contains('up')) mouse.classList.remove('up'); }, 600);
  }
  
  function whack(idx) {
    const mouse = document.getElementById(`mouse-${idx}`);
    if(mouse.classList.contains('up')) {
      mouse.classList.remove('up');
      const hit = document.getElementById(`hit-${idx}`);
      hit.classList.add('show');
      setTimeout(() => hit.classList.remove('show'), 500);
      mgScore += Math.floor(Math.random() * 50) + 50; // 50-100 gold per hit
      document.getElementById('mgScore').innerText = mgScore;
    }
  }
  
  function endMiniGame() {
    clearInterval(mgTimer);
    clearInterval(mgSpawnTimer);
    document.getElementById('miniGamePanel').classList.remove('active');
    let reward = mgScore;
    if(reward > 20000) reward = 20000;
    userGold += reward;
    updateStatusDisplay();
    alert(`æ¸¸æˆç»“æŸï¼ä½ æ‰åˆ°äº†ä»·å€¼ ${reward} é‡‘å¸çš„è€é¼ ï¼`);
    addGameLog(`çŒ«æ‰è€é¼ å¥–åŠ±: ${reward} G`, 'epic');
    saveUser();
  }
  
  function userGameRunning() { return isGameRunning; }

  // --- Shop System ---
  function toggleShop() {
    const p = document.getElementById('shopPanel');
    p.classList.toggle('active');
    updateShopPrices();
  }

  function updateShopPrices() {
    const costRod = 1000 * Math.pow(2, rodLevel);
    const costPond = 2000 * Math.pow(2, pondLevel);
    document.getElementById('priceRod').innerText = `${costRod} G (Lv.${rodLevel})`;
    document.getElementById('pricePond').innerText = `${costPond} G (Lv.${pondLevel})`;
  }

  async function buyItem(item) {
    if(!currentUser) return alert("è¯·å…ˆç™»å½•å­˜æ¡£ï¼");
    
    if(item === 'upgradeRod') {
      const cost = 1000 * Math.pow(2, rodLevel);
      if(userGold >= cost) {
        if(confirm(`èŠ±è´¹ ${cost}G å‡çº§é±¼ç«¿?`)) {
          userGold -= cost; rodLevel++;
          finishPurchase("é±¼ç«¿å‡çº§æˆåŠŸï¼ç¨€æœ‰ç‡æå‡ã€‚");
        }
      } else alert("é‡‘å¸ä¸è¶³ï¼");
    }
    else if(item === 'upgradePond') {
      const cost = 2000 * Math.pow(2, pondLevel);
      if(userGold >= cost) {
        if(confirm(`èŠ±è´¹ ${cost}G æ‰©å»ºé±¼å¡˜?`)) {
          userGold -= cost; pondLevel++;
          finishPurchase("é±¼å¡˜æ‰©å»ºæˆåŠŸï¼ä¸Šé±¼é€Ÿåº¦åŠ å¿«ã€‚");
        }
      } else alert("é‡‘å¸ä¸è¶³ï¼");
    }
    else if(item === 'goldChest') {
      if(userGold >= 5999) {
        userGold -= 5999;
        const roll = Math.random();
        let reward = 0;
        let msg = "";
        let type = "common";
        if (roll < 0.30) { 
          if (Math.random() < 0.1) { reward = 20000; msg = "ã€æ¬§çš‡é™ä¸´ã€‘ä½ ä»å®ç®±ä¸­å‘ç°äº†å·¨é¢è´¢å®ï¼"; type = "legend"; } 
          else { reward = 6000 + Math.floor(Math.random() * 4000); msg = "è¿æ°”ä¸é”™ï¼Œå°èµšä¸€ç¬”ï¼"; type = "rare"; }
        } else { 
           reward = 100 + Math.floor(Math.random() * 4000); msg = "å®ç®±é‡Œè£…æ»¡äº†çŸ³å¤´...";
        }
        userGold += reward;
        alert(`${msg} è·å¾— ${reward} é‡‘å¸`);
        finishPurchase(`å¼€å¯é£é™©å®ç®±: ${reward} G`);
      } else alert("é‡‘å¸ä¸è¶³ 5999");
    }
    else if(item === 'gameConsole') {
       if(userGold >= 3999) {
         if(confirm("èŠ±è´¹ 3999G ç©ä¸€æ¬¡çŒ«æ‰è€é¼ ï¼Ÿ")) {
           userGold -= 3999;
           updateStatusDisplay();
           toggleShop(); // close shop
           startMiniGame();
         }
       } else alert("é‡‘å¸ä¸è¶³ 3999");
    }
    else if(item === 'goldenRod') {
      if(userGold >= 19999) {
        if(confirm("è´­ä¹°é™æ—¶é‡‘åŠæ† (10åˆ†é’Ÿ)?")) {
          userGold -= 19999;
          goldenRodEndTime = Date.now() + 10 * 60 * 1000;
          document.getElementById('buffTimer').style.display = 'block';
          finishPurchase("é‡‘åŠæ†å·²æ¿€æ´»ï¼æ¥ä¸‹æ¥åªå‡ºå®ç®±ã€‚");
        }
      } else alert("é‡‘å¸ä¸è¶³");
    }
    else if(item === 'dogeCoin') {
      if(userGold >= 999999) {
        const addr = prompt("è¯·è¾“å…¥æ‚¨çš„ MetaMask é’±åŒ…åœ°å€ (ERC-20):");
        if(addr) {
          userGold -= 999999;
          finishPurchase("ç‹—ç‹—å¸è´­ä¹°æˆåŠŸï¼");
          setTimeout(() => alert(`ç³»ç»Ÿæ­£åœ¨å¤„ç†è½¬è´¦è‡³ ${addr.substr(0,6)}... \n(è¿™åªæ˜¯æ¨¡æ‹ŸåŠŸèƒ½)`), 500);
        }
      } else alert("é‡‘å¸ä¸è¶³ 999,999ï¼Œå¿«å»é’“ä¼ è¯´é±¼å§ï¼");
    }
  }

  function finishPurchase(msg) {
    addGameLog(msg, 'legend');
    updateStatusDisplay();
    updateShopPrices();
    saveUser();
  }
  
  function saveUser() {
    if(currentUser) {
      currentUser.set('gold', userGold);
      currentUser.set('rodLevel', rodLevel);
      currentUser.set('pondLevel', pondLevel);
      currentUser.save();
    }
  }

</script>
</body>
</html>
