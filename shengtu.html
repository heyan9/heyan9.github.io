<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>何岩 AI 工坊</title>
  <!-- 图标库 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LeanCloud SDK (百度极速源) -->
  <script src="https://code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
  
  <style>
    /* --- 何岩专属 UI 风格定义 --- */
    :root {
      --primary-blue: #0084ff;
      --hover-blue: #0077e6;
      --bg-color: #f4f6f9;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(255, 255, 255, 0.8);
      --text-main: #333;
      --text-sub: #8590a6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: var(--bg-color);
      /* 柔和的蓝调背景光斑 */
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 132, 255, 0.08) 0%, transparent 25%), 
        radial-gradient(circle at 90% 80%, rgba(0, 132, 255, 0.08) 0%, transparent 25%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 20px;
    }

    /* 毛玻璃卡片 */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid white;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }
    
    /* 输入框通用样式 */
    .input-clean {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 14px;
      outline: none;
      transition: all 0.3s;
      color: #374151;
      font-size: 14px;
    }
    .input-clean:focus {
      background: white;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 132, 255, 0.1);
    }

    /* 按钮样式 */
    .btn-main {
      background: var(--primary-blue);
      color: white;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 132, 255, 0.2);
    }
    .btn-main:hover {
      background: var(--hover-blue);
      transform: translateY(-1px);
    }
    .btn-main:active { transform: scale(0.98); }

    /* 标签样式 (去红化：反向词改为灰色系) */
    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 6px 6px 0;
      border: 1px solid transparent;
    }
    /* 正向标签：蓝底 */
    .tag-pos { background: #eef6ff; color: var(--primary-blue); border-color: #dbeafe; }
    .tag-pos:hover { background: #dbeafe; }
    /* 反向标签：灰底 (替代原本的红色) */
    .tag-neg { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; }
    .tag-neg:hover { background: #e5e7eb; color: #1f2937; }

    /* 图片生成区 */
    .img-preview {
      width: 100%;
      height: 300px; /* 固定高度 */
      background-color: #f3f4f6;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .img-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* 保持比例 */
      transition: opacity 0.5s;
    }

    /* 加载动画 */
    .loader {
      width: 20px; height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 底部备注栏输入框 */
    .note-input {
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- 主容器 -->
  <div class="w-full max-w-6xl flex flex-col gap-6 mb-10">

    <!-- 顶部 -->
    <div class="glass-card px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
          <i class="fas fa-layer-group"></i>
        </div>
        <div>
          <h1 class="font-bold text-gray-800 text-lg">AI 灵感工坊</h1>
          <p class="text-xs text-gray-400">Prompt & Image Generator</p>
        </div>
      </div>
      <!-- 连接状态 (使用中性色或绿色，不用红色) -->
      <div id="statusTag" onclick="testConnection()" class="cursor-pointer px-3 py-1 rounded-full bg-gray-100 text-gray-400 text-xs font-medium flex items-center gap-2 transition hover:bg-gray-200">
        <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
        <span id="statusText">连接云端中...</span>
      </div>
    </div>

    <!-- 1. 核心输入区 -->
    <div class="glass-card p-6">
      <label class="block text-sm font-bold text-gray-600 mb-2 flex items-center gap-2">
        <i class="fas fa-pen-fancy text-blue-500"></i>
        <span>画面描述 (中文自然语言)</span>
      </label>
      <div class="flex flex-col md:flex-row gap-4">
        <textarea id="userInput" class="input-clean flex-1 h-32 resize-none text-base leading-relaxed" 
          placeholder="例如：一位穿着赛博朋克机甲的少女，站在雨夜的霓虹灯街道上，电影质感，特写镜头..."></textarea>
        
        <button id="genBtn" onclick="generatePrompt()" class="btn-main md:w-40 py-3 md:py-0 flex flex-col justify-center items-center gap-1">
          <i class="fas fa-magic text-xl"></i>
          <span>生成提示词</span>
        </button>
      </div>
    </div>

    <!-- 2. 提示词输出区 (左右分栏) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <!-- 正向 (蓝色系) -->
      <div class="glass-card p-5 flex flex-col h-[500px]">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
          <h3 class="font-bold text-gray-700 flex items-center gap-2">
            <i class="fas fa-check-circle text-blue-500"></i> 正向提示词
          </h3>
          <button onclick="copyToClipboard('posOutput')" class="text-xs text-blue-500 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-md font-bold transition">
            复制英文
          </button>
        </div>
        <textarea id="posOutput" class="input-clean w-full h-32 mb-3 font-mono text-sm bg-gray-50 text-blue-800" placeholder="等待生成..."></textarea>
        
        <!-- 收藏区 -->
        <div class="flex-1 bg-white/60 rounded-xl border border-gray-200 flex flex-col overflow-hidden">
          <div class="p-2 border-b border-gray-200 flex gap-2 bg-gray-50/50">
            <input id="addPosTag" class="input-clean flex-1 py-1 text-xs" placeholder="输入英文Tag (自动翻译中文)">
            <button onclick="addCloudTag('positive')" class="bg-blue-500 text-white px-3 rounded-lg text-xs hover:bg-blue-600">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="posLib" class="flex-1 overflow-y-auto p-3 content-start">
            <div class="text-center text-gray-300 text-xs mt-8">加载中...</div>
          </div>
        </div>
      </div>

      <!-- 反向 (灰色系，无红) -->
      <div class="glass-card p-5 flex flex-col h-[500px]">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
          <h3 class="font-bold text-gray-700 flex items-center gap-2">
            <i class="fas fa-minus-circle text-gray-400"></i> 反向提示词
          </h3>
          <button onclick="copyToClipboard('negOutput')" class="text-xs text-gray-500 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-md font-bold transition">
            复制英文
          </button>
        </div>
        <textarea id="negOutput" class="input-clean w-full h-32 mb-3 font-mono text-sm bg-gray-50 text-gray-600" placeholder="等待生成..."></textarea>
        
        <!-- 收藏区 -->
        <div class="flex-1 bg-white/60 rounded-xl border border-gray-200 flex flex-col overflow-hidden">
          <div class="p-2 border-b border-gray-200 flex gap-2 bg-gray-50/50">
            <input id="addNegTag" class="input-clean flex-1 py-1 text-xs" placeholder="输入英文Tag (自动翻译中文)">
            <button onclick="addCloudTag('negative')" class="bg-gray-500 text-white px-3 rounded-lg text-xs hover:bg-gray-600">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="negLib" class="flex-1 overflow-y-auto p-3 content-start">
            <div class="text-center text-gray-300 text-xs mt-8">加载中...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. AI 绘图功能 (中间层) -->
    <div class="glass-card p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-image text-purple-500"></i> AI 试绘 (免Key)
            </h3>
            <button onclick="generateImage()" id="btnImgGen" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-2 rounded-full text-sm font-bold hover:shadow-lg transition transform active:scale-95 flex items-center gap-2">
                <i class="fas fa-paint-brush"></i> <span>生成预览图</span>
            </button>
        </div>
        
        <div class="flex flex-col md:flex-row gap-6">
            <!-- 图片显示区 -->
            <div class="img-preview shadow-inner border border-gray-200 relative group">
                <div id="imgPlaceholder" class="text-gray-400 text-sm flex flex-col items-center">
                    <i class="fas fa-image text-4xl mb-2 opacity-30"></i>
                    <span>点击右上角按钮生成图片</span>
                </div>
                <img id="resultImage" src="" alt="AI Result" class="opacity-0 absolute inset-0 z-10">
                <!-- 下载按钮浮层 -->
                <a id="downloadLink" href="#" target="_blank" class="hidden absolute bottom-4 right-4 bg-black/50 text-white px-3 py-1 rounded text-xs hover:bg-black/70 z-20 backdrop-blur-sm">
                    <i class="fas fa-download mr-1"></i> 打开原图
                </a>
            </div>
            
            <!-- 简易说明 -->
            <div class="md:w-1/3 flex flex-col justify-center text-sm text-gray-500 space-y-2">
                <p><i class="fas fa-info-circle mr-1"></i> <b>原理：</b>读取上方生成的“正向提示词”进行绘图。</p>
                <p><i class="fas fa-tachometer-alt mr-1"></i> <b>速度：</b>通常需要 5-10 秒。</p>
                <p><i class="fas fa-check mr-1"></i> <b>模型：</b>使用 Pollinations 开源接口，无需消耗本地算力。</p>
            </div>
        </div>
    </div>

    <!-- 4. 底部配置记录栏 (备注) -->
    <div class="glass-card p-6">
        <div class="mb-4 flex items-center gap-2 border-b border-gray-100 pb-2">
            <i class="fas fa-sliders-h text-gray-600"></i>
            <h3 class="font-bold text-gray-700">配置记录本 (Sampling & Settings)</h3>
            <span class="text-xs text-gray-400 ml-auto">自动保存在本地浏览器</span>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">采样方法 (Sampler)</label>
                <input type="text" id="noteSampler" class="input-clean note-input w-full" placeholder="e.g. Euler a" oninput="saveNotes()">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">迭代步数 (Steps)</label>
                <input type="text" id="noteSteps" class="input-clean note-input w-full" placeholder="e.g. 20" oninput="saveNotes()">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">提示词引导 (CFG Scale)</label>
                <input type="text" id="noteCfg" class="input-clean note-input w-full" placeholder="e.g. 7" oninput="saveNotes()">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">随机种子 (Seed)</label>
                <input type="text" id="noteSeed" class="input-clean note-input w-full" placeholder="e.g. -1" oninput="saveNotes()">
            </div>
            <div class="col-span-2 md:col-span-4 mt-2">
                 <label class="block text-xs text-gray-400 mb-1">其他备注 (Model, Lora, Notes...)</label>
                 <textarea id="noteExtra" class="input-clean note-input w-full h-20 resize-none" placeholder="记录你使用的底模、Lora权重或其他心得..." oninput="saveNotes()"></textarea>
            </div>
        </div>
    </div>

  </div>

  <!-- 5. 署名 Footer -->
  <footer class="text-center text-gray-400 text-xs pb-6 font-mono">
     <div class="mb-1">© 2025 AI Workshop</div>
     <div class="font-bold text-gray-500">这是何岩写的网站</div>
  </footer>

  <script>
    // --- 1. 配置 ---
    const APP_ID = "0fNWglSVWq6bfPeY4EgmAIXk-gzGzoHsz";
    const APP_KEY = "mtd6n4o06xmcHExxciaZBkvu";
    const SERVER_URL = "https://0fnwglsv.lc-cn-n1-shared.com";

    let isLCConnected = false;

    // --- 2. 初始化 ---
    window.onload = function() {
        initLeanCloud();
        loadNotes(); // 加载本地存储的备注
    };

    function initLeanCloud() {
        try {
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
            testConnection();
        } catch (e) {
            console.error(e);
            setStatus(false, "SDK 错误");
        }
    }

    async function testConnection() {
        setStatus(false, "连接中...");
        try {
            const query = new AV.Query('PromptTags');
            query.limit(1);
            await query.find();
            setStatus(true, "云端已同步");
            loadLibrary('positive');
            loadLibrary('negative');
        } catch (e) {
            // 101 code means Class doesn't exist yet, which is fine (connected but empty)
            if(e.code === 101) {
                setStatus(true, "云端就绪");
                loadLibrary('positive');
                loadLibrary('negative');
            } else {
                console.error(e);
                setStatus(false, "连接断开");
            }
        }
    }

    function setStatus(isOnline, text) {
        isLCConnected = isOnline;
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        const tag = document.getElementById('statusTag');
        
        txt.innerText = text;
        if(isOnline) {
            dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#4ade80]";
            tag.classList.add('text-green-600', 'bg-green-50');
            tag.classList.remove('text-gray-400', 'bg-gray-100', 'text-orange-500', 'bg-orange-50');
        } else {
            // 使用橙色或灰色代替红色
            dot.className = "w-2 h-2 rounded-full bg-orange-400";
            tag.classList.add('text-orange-500', 'bg-orange-50');
            tag.classList.remove('text-green-600', 'bg-green-50', 'text-gray-400', 'bg-gray-100');
        }
    }

    // --- 3. 提示词生成 (AI Text) ---
    async function generatePrompt() {
        const input = document.getElementById('userInput').value.trim();
        if(!input) return alert("请先输入画面描述");

        const btn = document.getElementById('genBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = `<div class="loader" style="border-top-color:white; width:16px; height:16px; border-width:2px;"></div>`;
        btn.disabled = true;

        const systemPrompt = `Role: Stable Diffusion Prompt Expert.
        Task: Translate Chinese description to English Prompts.
        Output: JSON format {"positive": "...", "negative": "..."}.
        Rules: Positive adds quality tags. Negative adds standard bad tags.
        Input: ${input}`;

        try {
            const res = await fetch('https://text.pollinations.ai/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: input }],
                    model: 'openai', jsonMode: true
                })
            });
            const text = await res.text();
            let data;
            try {
                const match = text.match(/\{[\s\S]*\}/);
                data = match ? JSON.parse(match[0]) : { positive: text, negative: "lowres, bad anatomy" };
            } catch(e) { data = { positive: text, negative: "lowres" }; }

            document.getElementById('posOutput').value = data.positive;
            document.getElementById('negOutput').value = data.negative;
        } catch(e) {
            alert("生成超时，请重试");
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // --- 4. 图片生成 (AI Image) ---
    function generateImage() {
        const prompt = document.getElementById('posOutput').value.trim();
        if(!prompt) return alert("请先生成或输入正向提示词！");

        const btn = document.getElementById('btnImgGen');
        const img = document.getElementById('resultImage');
        const placeholder = document.getElementById('imgPlaceholder');
        const dlLink = document.getElementById('downloadLink');

        // UI Loading
        const oldBtnText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在绘图...';
        btn.disabled = true;
        
        // Hide previous
        img.classList.add('opacity-0');
        dlLink.classList.add('hidden');
        placeholder.style.display = 'flex';

        // Pollinations Image API
        // Format: https://image.pollinations.ai/prompt/{prompt}?nologo=true
        const encodedPrompt = encodeURIComponent(prompt);
        // 添加随机数防止缓存
        const randomSeed = Math.floor(Math.random() * 10000);
        const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&seed=${randomSeed}&width=1024&height=512`;

        // Preload image
        const newImg = new Image();
        newImg.src = url;
        newImg.onload = function() {
            img.src = url;
            img.classList.remove('opacity-0');
            placeholder.style.display = 'none';
            btn.innerHTML = oldBtnText;
            btn.disabled = false;
            
            // Setup download link
            dlLink.href = url;
            dlLink.classList.remove('hidden');
        };
        newImg.onerror = function() {
            alert("生成图片失败，请稍后重试");
            btn.innerHTML = oldBtnText;
            btn.disabled = false;
        };
    }

    // --- 5. LeanCloud 收藏库 ---
    async function loadLibrary(type) {
        if(!isLCConnected) return;
        const container = document.getElementById(type === 'positive' ? 'posLib' : 'negLib');
        const query = new AV.Query('PromptTags');
        query.equalTo('type', type);
        query.descending('createdAt');
        query.limit(50);
        
        try {
            const results = await query.find();
            container.innerHTML = '';
            if(results.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-300 text-xs mt-4">暂无收藏</div>';
                return;
            }
            
            results.forEach(obj => {
                const en = obj.get('tag');
                const cn = obj.get('translation');
                const id = obj.id;
                
                // Determine style based on type
                const styleClass = type === 'positive' ? 'tag-pos' : 'tag-neg';
                
                const div = document.createElement('div');
                div.className = `tag-pill group ${styleClass}`;
                div.innerHTML = `
                    <span onclick="appendTag('${type}', '${en.replace(/'/g,"\\'")}')">${cn}</span>
                    <i class="fas fa-times ml-2 opacity-0 group-hover:opacity-100 hover:text-gray-900 transition" onclick="deleteTag('${id}', '${type}')"></i>
                `;
                container.appendChild(div);
            });
        } catch(e) { console.error(e); }
    }

    async function addCloudTag(type) {
        if(!isLCConnected) return alert("云端未连接");
        const inputId = type === 'positive' ? 'addPosTag' : 'addNegTag';
        const el = document.getElementById(inputId);
        const tag = el.value.trim();
        if(!tag) return;
        
        // Button loading
        const btn = el.nextElementSibling;
        const oldHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // Translate
            const res = await fetch(`https://text.pollinations.ai/Translate "${tag}" to Chinese concise word. No explanation.`);
            let cn = await res.text();
            cn = cn.replace(/"/g, '').trim();
            
            const Obj = AV.Object.extend('PromptTags');
            const o = new Obj();
            o.set('type', type); o.set('tag', tag); o.set('translation', cn);
            await o.save();
            el.value = '';
            loadLibrary(type);
        } catch(e) { alert("保存失败"); } 
        finally { btn.innerHTML = oldHTML; }
    }

    async function deleteTag(id, type) {
        if(!confirm("删除此标签？")) return;
        try {
            const o = AV.Object.createWithoutData('PromptTags', id);
            await o.destroy();
            loadLibrary(type);
        } catch(e) { alert("删除失败"); }
    }

    // --- 6. 辅助功能 ---
    function appendTag(type, text) {
        const area = document.getElementById(type === 'positive' ? 'posOutput' : 'negOutput');
        let val = area.value.trim();
        if(val && !val.endsWith(',')) val += ', ';
        area.value = val + text + ', ';
    }

    function copyToClipboard(id) {
        document.getElementById(id).select();
        document.execCommand('copy');
        // Visual feedback
        const btn = document.querySelector(`button[onclick="copyToClipboard('${id}')"]`);
        const old = btn.innerText;
        btn.innerText = "已复制!";
        setTimeout(() => btn.innerText = old, 1000);
    }

    // --- 7. 本地备注存储 (LocalStorage) ---
    function saveNotes() {
        const data = {
            sampler: document.getElementById('noteSampler').value,
            steps: document.getElementById('noteSteps').value,
            cfg: document.getElementById('noteCfg').value,
            seed: document.getElementById('noteSeed').value,
            extra: document.getElementById('noteExtra').value
        };
        localStorage.setItem('heyan_ai_notes', JSON.stringify(data));
    }

    function loadNotes() {
        const saved = localStorage.getItem('heyan_ai_notes');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('noteSampler').value = data.sampler || '';
            document.getElementById('noteSteps').value = data.steps || '';
            document.getElementById('noteCfg').value = data.cfg || '';
            document.getElementById('noteSeed').value = data.seed || '';
            document.getElementById('noteExtra').value = data.extra || '';
        }
    }
  </script>
</body>
</html>