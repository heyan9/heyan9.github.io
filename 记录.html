<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½•å²©äº‘ç«¯ç©ºé—´</title>
    <!-- å¼•å…¥å­—ä½“å›¾æ ‡ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --zhihu-blue: #0084ff;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            color: #444;
            min-height: 100vh;
            /* é»˜è®¤å±•å¼€æ—¶çš„èƒŒæ™¯ */
            background-color: #f6f6f6;
            transition: background 0.5s ease;
            overflow-x: hidden;
        }

        /* åŠ¨æ€èƒŒæ™¯å±‚ */
        #wallpaper-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0; /* é»˜è®¤éšè— */
            z-index: -1;
            transition: opacity 1s ease-in-out, background-image 1s ease-in-out;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 60px;
            transition: opacity 0.5s, transform 0.5s;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header-area {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo-img {
            max-height: 60px; /* Logoå¤§å°æ§åˆ¶ */
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo-img:hover { transform: scale(1.05); }

        /* çŸ¥ä¹æœç´¢æ¡† */
        .search-box {
            display: flex;
            max-width: 400px;
            margin: 15px auto 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .search-box input {
            border: none;
            background: transparent;
            padding: 10px 15px;
            flex: 1;
            outline: none;
        }
        .search-box button {
            background: var(--zhihu-blue);
            color: white;
            border: none;
            padding: 0 20px;
            cursor: pointer;
        }

        /* æ¯›ç»ç’ƒå¡ç‰‡ */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        h2 {
            margin-top: 0;
            color: var(--zhihu-blue);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* é€šç”¨è¾“å…¥ä¸æŒ‰é’® */
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input.text-in {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            background: rgba(255,255,255,0.8);
        }
        button.add-btn {
            background: var(--zhihu-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* åˆ—è¡¨ */
        ul { list-style: none; padding: 0; margin: 0; }
        li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-box { display: flex; flex-direction: column; }
        .meta-info { font-size: 12px; color: #999; margin-top: 4px; }
        .del-btn { color: #ccc; border: none; background: none; cursor: pointer; }
        .del-btn:hover { color: #ff4d4f; }

        /* --- ç‰¹æ®Šæ¨¡å—ï¼šç¥åœ£æ‰“å¡ --- */
        .counter-box { text-align: center; padding: 10px 0; position: relative; }
        .level-display { font-size: 28px; margin: 10px 0; letter-spacing: 3px; min-height: 35px;}
        .count-number { font-size: 56px; font-weight: bold; color: #333; }
        .btn-row { display: flex; justify-content: center; gap: 20px; align-items: center; margin-top: 10px;}
        .circle-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: white; color: #555;
        }
        .circle-btn.main { background: var(--zhihu-blue); color: white; width: 60px; height: 60px; font-size: 24px;}
        .reset-btn {
            position: absolute; top: 0; right: 0;
            background: none; border: none; color: #ddd; font-size: 12px; cursor: pointer;
        }
        .reset-btn:hover { color: #ff4d4f; text-decoration: underline; }

        /* --- ç‰¹æ®Šæ¨¡å—ï¼šéšæœºå»å“ªç© --- */
        .random-result {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            padding: 20px;
            background: rgba(0, 132, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            min-height: 32px;
        }
        .pick-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #0084ff, #0055ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.1s;
        }
        .pick-btn:active { transform: scale(0.98); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-item {
            font-size: 12px; padding: 4px 8px; background: #eee; border-radius: 4px; color: #666;
            display: flex; align-items: center; gap: 5px;
        }

        /* --- åº•éƒ¨ä¸æ§åˆ¶ --- */
        .footer-bar {
            text-align: center;
            margin-top: 40px;
            font-size: 14px;
            color: #999;
            font-family: monospace;
        }

        /* æ‚¬æµ®æ§åˆ¶æŒ‰é’® (æ”¶èµ·/å±•å¼€) */
        #toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        #toggle-btn:hover { background: var(--zhihu-blue); }

        /* --- æ²‰æµ¸æ¨¡å¼ (æ”¶èµ·å) --- */
        .hidden-mode .container {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }
        
        .hidden-mode #wallpaper-layer {
            opacity: 1; /* æ˜¾ç¤ºèƒŒæ™¯å›¾ */
        }

        /* å±å¹•ä¸­å¤®å¤§æ—¶é’Ÿ */
        #center-clock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 100;
        }
        .hidden-mode #center-clock {
            opacity: 1;
        }
        #center-clock .time-big { font-size: 80px; font-weight: 200; line-height: 1;}
        #center-clock .date-big { font-size: 24px; font-weight: 300; margin-top: 10px; opacity: 0.9;}

    </style>
</head>
<body>

    <!-- èƒŒæ™¯å±‚ -->
    <div id="wallpaper-layer"></div>

    <!-- æ‚¬æµ®å¼€å…³ -->
    <button id="toggle-btn" onclick="toggleView()" title="åˆ‡æ¢æ²‰æµ¸æ¨¡å¼">
        <i class="fas fa-compress-arrows-alt"></i>
    </button>

    <!-- å±å¹•ä¸­å¤®æ—¶é’Ÿ (é»˜è®¤éšè—) -->
    <div id="center-clock">
        <div class="time-big" id="big-time-display">00:00</div>
        <div class="date-big" id="big-date-display">10æœˆ24æ—¥ æ˜ŸæœŸäºŒ</div>
    </div>

    <!-- ä¸»å†…å®¹å®¹å™¨ -->
    <div class="container" id="main-content">
        
        <!-- 1. å¤´éƒ¨ Logo + æœç´¢ -->
        <div class="header-area">
            <a href="https://heyan9.github.io">
                <img src="img/logo1.png" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/150x50?text=LOGO'">
            </a>
            
            <div class="search-box">
                <input type="text" id="zhihu-input" placeholder="æœç´¢çŸ¥ä¹å†…å®¹..." onkeypress="handleSearch(event)">
                <button onclick="searchZhihu()"><i class="fas fa-search"></i></button>
            </div>
        </div>

        <!-- 2. ç¥åœ£å·¥ä½œä½ -->
        <div class="card">
            <h2>âœ¨ ç¥åœ£å·¥ä½œä½</h2>
            <div class="counter-box">
                <button class="reset-btn" onclick="resetCounter()">æ¸…ç©ºå½’é›¶</button>
                <span class="count-number" id="holy-count">--</span>
                <div class="level-display" id="holy-visual"></div>
                <div class="btn-row">
                    <button class="circle-btn" onclick="updateCounter(-1)">-1</button>
                    <button class="circle-btn main" onclick="updateCounter(1)">+1</button>
                </div>
                <p style="font-size:12px; color:#999;">10ğŸŒŸ=1ğŸŒ™ | 10ğŸŒ™=1â˜€ï¸</p>
            </div>
        </div>

        <!-- 3. ä»Šå¤©ç©ä»€ä¹ˆ (éšæœºæŠ½å–) -->
        <div class="card">
            <h2>ğŸ² ä»Šå¤©ç©ä»€ä¹ˆï¼Ÿ</h2>
            <div class="random-result" id="random-display">???</div>
            <button class="pick-btn" onclick="drawActivity()">âš¡ï¸ å¸®æˆ‘é€‰ä¸€ä¸ªï¼</button>
            
            <div class="input-group">
                <input type="text" class="text-in" id="activity-input" placeholder="æ·»åŠ æ–°ç©æ³• (å¦‚: å¯†å®¤é€ƒè„±)">
                <button class="add-btn" onclick="addItem('activity')">æ·»åŠ </button>
            </div>
            
            <!-- æ˜¾ç¤ºäº‘ç«¯æ·»åŠ çš„è‡ªå®šä¹‰ç©æ³•ï¼Œæ–¹ä¾¿åˆ é™¤ -->
            <div style="font-size:12px; color:#999; margin-bottom:5px;">è‡ªå»ºåº“ (å¯åˆ ):</div>
            <div class="tag-list" id="list-activity"></div>
        </div>

        <!-- 4. å€’è®¡æ—¶ & çºªå¿µæ—¥ -->
        <div class="card">
            <h2>â³ å€’è®¡æ—¶ & çºªå¿µæ—¥</h2>
            <div class="input-group">
                <input type="text" class="text-in" id="cd-title" placeholder="äº‹é¡¹åç§°">
                <input type="date" class="text-in" id="cd-date">
                <button class="add-btn" onclick="addItem('countdown')">æ·»åŠ </button>
            </div>
            <ul id="list-countdown"></ul>
        </div>

        <!-- 5. å¤‡å¿˜å½• -->
        <div class="card">
            <h2>ğŸ“ éšæ‰‹è®°å¤‡å¿˜å½•</h2>
            <div class="input-group">
                <input type="text" class="text-in" id="memo-input" placeholder="è¾“å…¥å†…å®¹...">
                <button class="add-btn" onclick="addItem('memo')">è®°å½•</button>
            </div>
            <ul id="list-memo"></ul>
        </div>

        <!-- 6. è¯»ä¹¦ç¬”è®° -->
        <div class="card">
            <h2>ğŸ“– è¯»ä¹¦ç¬”è®°</h2>
            <div class="input-group">
                <input type="text" class="text-in" id="book-input" placeholder="ä¹¦å / ç¬”è®°...">
                <button class="add-btn" onclick="addItem('book')">å­˜å…¥</button>
            </div>
            <ul id="list-book"></ul>
        </div>

        <!-- 7. æ—…è¡Œè¶³è¿¹ -->
        <div class="card">
            <h2>âœˆï¸ æ—…è¡Œè¶³è¿¹</h2>
            <div class="input-group">
                <input type="text" class="text-in" id="city-input" placeholder="åŸå¸‚åç§°...">
                <button class="add-btn" onclick="addItem('city')">æ‰“å¡</button>
            </div>
            <ul id="list-city"></ul>
        </div>

        <!-- åº•éƒ¨å®æ—¶æ—¶é—´ -->
        <div class="footer-bar">
            <span id="footer-time">Loading...</span>
        </div>

    </div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // -------------------------------------------------------------
    // ğŸ”´ é…ç½®åŒºåŸŸ
    // -------------------------------------------------------------
    const SUPABASE_URL = 'https://rxesvdcrgybakkuemlxx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_4hw7c7mcUBnZnQ-fy8ougA_lS-mfKlj';
    // -------------------------------------------------------------

    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨å±€å˜é‡
    let counterId = null;
    let currentCount = 0;
    
    // é»˜è®¤æ´»åŠ¨æ± 
    const defaultActivities = [
        "æ‰“å°çƒ", "ä¸»æœºæ¸¸æˆ", "çœ‹ç”µå½±", "å–å¥¶èŒ¶", 
        "æ¸¸æˆå…", "KTVå”±æ­Œ", "å–é…’", "é€›è¡—", 
        "å»æ—…æ¸¸/å¤–åœ°", "çœ‹æ¼”å‡º", "å®…å®¶é‡Œ", "æ•£æ­¥"
    ];
    let customActivities = []; // ä»äº‘ç«¯æ‹‰å–

    // --- åˆå§‹åŒ–ä¸å®æ—¶åŒæ­¥ ---
    function init() {
        fetchData();
        updateTime(); // å¯åŠ¨æ—¶é’Ÿ
        setInterval(updateTime, 1000); // æ¯ç§’æ›´æ–°æ—¶é—´

        _supabase.channel('custom-all-channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'app_data' }, () => {
            fetchData();
        })
        .subscribe();
    }

    async function fetchData() {
        const { data, error } = await _supabase
            .from('app_data')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) return;

        // æ¸…ç©º UI
        ['list-memo', 'list-book', 'list-city', 'list-countdown', 'list-activity'].forEach(id => {
            document.getElementById(id).innerHTML = '';
        });
        customActivities = []; // é‡ç½®è‡ªå®šä¹‰æ´»åŠ¨åˆ—è¡¨

        let counterFound = false;

        data.forEach(item => {
            if (item.type === 'memo') renderList('list-memo', item);
            else if (item.type === 'book') renderList('list-book', item);
            else if (item.type === 'city') renderList('list-city', item);
            else if (item.type === 'countdown') renderCountdown(item);
            else if (item.type === 'activity') {
                customActivities.push(item.content); // åŠ å…¥æ± å­
                renderActivityTag(item); // æ˜¾ç¤ºåœ¨ä¸‹æ–¹ä»¥ä¾¿åˆ é™¤
            }
            else if (item.type === 'counter') {
                counterFound = true;
                counterId = item.id;
                currentCount = item.count_val;
                renderCounter(currentCount);
            }
        });

        // è‡ªåŠ¨åˆ›å»ºè®¡æ•°å™¨
        if (!counterFound && data) {
            await _supabase.from('app_data').insert([{ type: 'counter', count_val: 0 }]);
        }
    }

    // --- åŠŸèƒ½é€»è¾‘ ---

    // 1. æœç´¢
    function handleSearch(e) { if(e.key === 'Enter') searchZhihu(); }
    function searchZhihu() {
        const val = document.getElementById('zhihu-input').value;
        if(val) window.open(`https://www.zhihu.com/search?q=${encodeURIComponent(val)}&type=content`, '_blank');
    }

    // 2. éšæœºæŠ½å–
    function drawActivity() {
        const pool = [...defaultActivities, ...customActivities];
        const display = document.getElementById('random-display');
        
        // ç®€å•çš„æŠ½å¥–åŠ¨ç”»æ•ˆæœ
        let count = 0;
        const interval = setInterval(() => {
            display.innerText = pool[Math.floor(Math.random() * pool.length)];
            count++;
            if(count > 10) {
                clearInterval(interval);
                // æœ€ç»ˆç»“æœ
                display.style.color = '#0084ff';
                display.style.transform = 'scale(1.2)';
                setTimeout(()=> display.style.transform = 'scale(1)', 200);
            }
        }, 50);
    }

    // 3. è®¡æ•°å™¨é€»è¾‘
    async function updateCounter(amount) {
        if (!counterId) return;
        const newCount = currentCount + amount;
        if (newCount < 0) return;
        
        // ä¹è§‚æ›´æ–°
        renderCounter(newCount);
        currentCount = newCount;
        
        await _supabase.from('app_data').update({ count_val: newCount }).eq('id', counterId);
    }

    async function resetCounter() {
        if (!counterId) return;
        if(confirm('ç¡®å®šè¦æ¸…ç©ºç¥åœ£å·¥ä½œä½çš„è®°å½•å—ï¼Ÿ')) {
            renderCounter(0);
            currentCount = 0;
            await _supabase.from('app_data').update({ count_val: 0 }).eq('id', counterId);
        }
    }

    function renderCounter(num) {
        document.getElementById('holy-count').innerText = num;
        const suns = Math.floor(num / 1000);
        const moons = Math.floor((num % 1000) / 100);
        const stars = Math.floor((num % 100) / 10);
        
        let html = '';
        for(let i=0; i<suns; i++) html += 'â˜€ï¸';
        for(let i=0; i<moons; i++) html += 'ğŸŒ™';
        for(let i=0; i<stars; i++) html += 'â­';
        if(html === '') html = '<span style="font-size:14px;color:#eee">--</span>';
        document.getElementById('holy-visual').innerHTML = html;
    }

    // 4. æ¸²æŸ“åˆ—è¡¨
    function renderList(elId, item) {
        const ul = document.getElementById(elId);
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="content-box">
                <span style="font-size:15px;">${item.content}</span>
                <span class="meta-info">${new Date(item.created_at).toLocaleString()}</span>
            </div>
            <button class="del-btn" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
        `;
        ul.appendChild(li);
    }

    function renderCountdown(item) {
        const ul = document.getElementById('list-countdown');
        const li = document.createElement('li');
        const diffDays = Math.ceil((new Date(item.extra_info) - new Date()) / (86400000));
        let str = diffDays > 0 ? `<b style="color:#0084ff">${diffDays}å¤©</b> å` : (diffDays === 0 ? `<b style="color:red">ä»Šå¤©</b>` : `å·²è¿‡ <b style="color:#999">${Math.abs(diffDays)}å¤©</b>`);
        
        li.innerHTML = `
            <div class="content-box">
                <span>${item.content}</span>
                <span class="meta-info">${item.extra_info}</span>
            </div>
            <div>${str} <button class="del-btn" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button></div>
        `;
        ul.appendChild(li);
    }

    function renderActivityTag(item) {
        const div = document.getElementById('list-activity');
        const span = document.createElement('span');
        span.className = 'tag-item';
        span.innerHTML = `${item.content} <i class="fas fa-times" style="cursor:pointer;margin-left:4px;" onclick="deleteItem(${item.id})"></i>`;
        div.appendChild(span);
    }

    // 5. é€šç”¨å¢åˆ 
    async function addItem(type) {
        let content = '';
        let extra = null;

        if(type === 'memo') content = document.getElementById('memo-input').value;
        if(type === 'book') content = document.getElementById('book-input').value;
        if(type === 'city') content = document.getElementById('city-input').value;
        if(type === 'activity') content = document.getElementById('activity-input').value;
        if(type === 'countdown') {
            content = document.getElementById('cd-title').value;
            extra = document.getElementById('cd-date').value;
            if(!extra) return alert('è¯·é€‰æ—¥æœŸ');
        }

        if(!content.trim()) return;

        await _supabase.from('app_data').insert([{ type, content, extra_info: extra }]);
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    async function deleteItem(id) {
        if(confirm('åˆ é™¤æ­¤æ¡è®°å½•?')) await _supabase.from('app_data').delete().eq('id', id);
    }

    // 6. è§†å›¾åˆ‡æ¢ä¸èƒŒæ™¯è½®æ’­
    let isHidden = false;
    let bgTimer = null;
    let bgIndex = 1;

    function toggleView() {
        isHidden = !isHidden;
        const body = document.body;
        const btn = document.getElementById('toggle-btn');
        const wallpaper = document.getElementById('wallpaper-layer');

        if (isHidden) {
            // æ”¶èµ·æ¨¡å¼
            body.classList.add('hidden-mode');
            btn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾
            changeBackground(); 
            // å¼€å¯è½®æ’­
            bgTimer = setInterval(changeBackground, 30000); // 30ç§’
        } else {
            // å±•å¼€æ¨¡å¼
            body.classList.remove('hidden-mode');
            btn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
            clearInterval(bgTimer);
            wallpaper.style.opacity = 0; // éšè—èƒŒæ™¯å›¾
        }
    }

    function changeBackground() {
        const wallpaper = document.getElementById('wallpaper-layer');
        // é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ï¼Œé¿å…é—ªçƒï¼ˆç®€å•å¤„ç†ï¼šç›´æ¥è®¾ï¼‰
        wallpaper.style.backgroundImage = `url('img/beijin${bgIndex}.png')`;
        wallpaper.style.opacity = 1;
        
        // ç´¢å¼•+1ï¼Œè¶…è¿‡15å½’1
        bgIndex++;
        if(bgIndex > 15) bgIndex = 1;
    }

    // 7. æ—¶é—´æ›´æ–°
    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
        const dateStr = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

        // åº•éƒ¨å°æ—¶é—´
        document.getElementById('footer-time').innerText = `${dateStr} ${timeStr}`;
        
        // ä¸­é—´å¤§æ—¶é—´
        document.getElementById('big-time-display').innerText = timeStr.slice(0, 5); // åªæ˜¾ç¤º 12:30
        document.getElementById('big-date-display').innerText = dateStr;
    }

    init();
</script>
</body>
</html>